<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>如何做好压测 - Longbao</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="如何做好压测"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-12-02 16:10" pubdate>2021年12月2日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 32 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">如何做好压测</h1><div class="markdown-body"><h3 id="压测的目标是什么？"><a href="#压测的目标是什么？" class="headerlink" title="压测的目标是什么？"></a>压测的目标是什么？</h3><p>压测的目标有两个：</p><ol><li>通过对模块的压测，找到模块的性能瓶颈，分析其资源耗用合理性、架构可扩展性，找到优化方向。</li><li>通过对链路的压测，找到链路的性能瓶颈，回答线上资源容量。 ^20d5ad</li></ol><h3 id="压测的技能栈有什么？"><a href="#压测的技能栈有什么？" class="headerlink" title="压测的技能栈有什么？"></a>压测的技能栈有什么？</h3><p>压测的技能栈要求非常广泛，整体来说，需要具备这些技能：</p><ol><li>测试人员的思维习惯和方法论。找到合适的测试模型，并准备好/管理好这些数据。</li><li>运维人员的对系统的认识。能够根据需要配置合适的系统资源，能够一定程度上进行系统问题排查。</li><li>开发人员的开发能力。往往在数据准备过程、测试过程中，需要有较多的工具类开发。</li><li>数据分析人员的分析能力。在数据准备和压测过程中，需要提前预规划各类指标与数据，用于分析系统状态，有时需要比较强的数据分析能力。</li><li>对业务系统熟悉。能够在一定程度上进行问题排查。</li><li>对常用的中间件熟悉。能够进行常规中间件的性能评估与异常分析，例如 <code>kafka</code>、<code>mongodb</code>、<code>mysql</code>、<code>redis</code> 等。</li></ol><p>具体的技能，需要根据业务情况而定。但也有一些通用的技能：</p><ol><li>工作规划能力。由于压测的工作往往十分庞杂，因此要能规划好工作内容，各个阶段的安排要合理。</li><li>文档书写能力。压测的过程十分庞杂，因此每个阶段的工作都应该有比较好的记录和分析，用于指导下一环节的工作。常写的文档包括： 1. 压测规划书 2. 压测结果记录 3. 压测分析报告 4. 系统结构分析图。</li><li>沟通能力。由于压测涉及到的范围很广，尤其是一个比较大的链路压测时，压测人员基本无法对整个系统有较强的掌控能力，需要 1. 市场/运营人员 2. 模块开发负责人员 3. 运维人员 的参与，因此协调这些人员的工作就会十分重要。</li></ol><h3 id="压测的形态是怎样的？"><a href="#压测的形态是怎样的？" class="headerlink" title="压测的形态是怎样的？"></a>压测的形态是怎样的？</h3><ol><li>压测可以分为基准测试和链路测试。基准测试是对单个模块的压测。链路压测是对一条业务流程的压测。</li><li>对于一个常规的压测流程，应当先对模块进行基准测试，在得到每个模块的性能指标后，再进行链路压测。</li></ol><h3 id="压测的结论有哪些？"><a href="#压测的结论有哪些？" class="headerlink" title="压测的结论有哪些？"></a>压测的结论有哪些？</h3><ol><li>回答压测的模型是怎样的，说明为什么选择这样的压测模型</li><li>回答在目标QPS下，当前的系统瓶颈是什么</li><li>给出压测过程中发现的不合理之处</li></ol><h3 id="压测的流程是怎样的？"><a href="#压测的流程是怎样的？" class="headerlink" title="压测的流程是怎样的？"></a>压测的流程是怎样的？</h3><ol><li>分析业务形态，系统形态</li><li>根据业务需求，确定合适的压测模型</li><li>准备压测环境</li><li>准备压测数据、压测工具</li><li>确定系统可观测性，确定测试终止条件</li><li>压测执行，处理过程中的问题</li><li>根据压测过程，形成压测报告</li><li>根据压测报告进行分析，形成分析报告</li></ol><h3 id="压测的工程化实践"><a href="#压测的工程化实践" class="headerlink" title="压测的工程化实践"></a>压测的工程化实践</h3><p>业务系统的压测(从链路来看)，往往可以分为这两类：</p><ol><li>http 请求</li><li>其他类 TCP 请求</li></ol><p>由于业务系统主要面向用户，因此对于 http 请求的压测是最多的，这也是市场上生态最好的类型。常规的例如 <code>jmeter</code>、<code>locust</code>、<code>k6</code>、<code>PTS</code>、<code>loadrunner</code> ，这是用于系统性压测的工具。另外，在开发人员保障的性能测试中，<code>ab</code> 、<code>wrk</code> 、<code>go-stress-testing</code> 这几个工具被经常使用，用于快速验证。<br>其他类的请求相对较少，例如 <code>rpc</code>、<code>websocket</code> 这类。即使有一些实现，但真正结合到业务中时，会发现各种不满足需求。实际上，这类测试最好还是自己根据业务情况写项目实现。<br>压测项目是一个比较具有通用性的项目，因此可以考虑将其平台化，但目前来看，在最通用的 http 压测上，是比较容易平台化的，市场上也有很多，例如上面提到的 <code>jmeter</code>、<code>loadrunner</code> 等。不过，市面上的这类工具基本都是用来进行 压力管理 的，而测试计划、测试脚本、测试报告 等方面的管理是比较弱的，因此，也有企业在开始做云端化的压测管理平台，比如 <code>metersphere</code>，现在做得也基本可用了。</p><p>对于接口类的测试，通用性是非常强的，例如和 接口管理 结合，可以实现类似于：<code>自动化生成测试用例</code>、<code>流量录制</code>、<code>测试跟踪(bug管理等)</code>、<code>基于接口测试的性能测试</code>等等。实际上，这些功能 <code>metersphere</code> 也支持了，不过有部分是企业版的(如项目管理平台集成)。<br>对于接口类测试，我们当前使用的是自己开发的一个项目 <code>super-apitest</code> ，这个项目的最大亮点在于 基于json的模板化用例 ，这点可以认为和 jmeter 的 jmx 格式类比，不过基于 json 的格式，对开发者更加友好。<br>现在这个项目仅有一些简单的功能，例如适配了简单的触发界面、结果报告、结果通知，但想要真正做到平台化，还有非常长的路要走。<br>当前来看，这个项目可以在一定程度上进行平台化，主要的功能点有 3 个：</p><ol><li>支持所有用例使用数据库管理 =&gt; 一切演进的前提</li><li>支持测试用例录制 =&gt; 极大简化用例生成方式</li><li>支持测试用例通过率统计 =&gt; 极大增强测试跟踪</li></ol><p>如果做到这 3 点，这个接口测试平台已经基本可用了。</p><p>对于其他类型的功能测试，主要包括</p><ol><li>工具库的单测和覆盖度测试</li><li>模块的功能测试</li><li>非 http 类的接口测试 (例如 rpc、ws、异步消息)</li></ol><p>这些测试基本不具备很好的通用性，平台化的效率比较低，对于这类测试，平台的作用其实主要有:</p><ol><li>测试触发</li><li>测试用例元信息管理</li><li>测试结果展示</li></ol><p>基于此，可以认为，平台仅需要提供特定的接口，由各测试项目自行实现测试触发、测试结果反馈即可。</p><p>对于性能测试，如果全为 http 类接口，则平台化的效率较高，可以直接和 接口测试 模块相结合，由接口测试提供用例，由性能测试模块提供压测控制。<br>同样，对于非 http 类接口而言，性能测试的通用性就比较弱了，比如各个项目的性能。那么平台依然可以提供测试管理接口，由平台来做触发和结果采集，实际的测试执行由各业务项目自行处理。</p><h3 id="功能测试和性能测试的关系"><a href="#功能测试和性能测试的关系" class="headerlink" title="功能测试和性能测试的关系"></a>功能测试和性能测试的关系</h3><p>功能测试的目的在于保证功能的正确性，有时会有比较复杂的校验逻辑，测试用例集的组织形式经常为一个功能。<br>性能测试的目的在于摸清一些功能或场景的最大(合适)并发度，用于排查性能瓶颈和做线上资源容量规划，校验逻辑往往比较轻量，着重在压力 ，测试用例集的组织形式尝尝是一系列场景，并且十分关注各场景的比例，目的模拟真实用户的请求。</p><h3 id="压测项目的价值有多大"><a href="#压测项目的价值有多大" class="headerlink" title="压测项目的价值有多大"></a>压测项目的价值有多大</h3><p>根据压测的两大目标来看： 1. 发现系统瓶颈，提供优化建议 2. 回答线上容量问题<br>对于第 1 点，这是项目开发时需要的，例如开发一个通用的库，需要根据压测的结果进行优化。实际上，这是任何一个开发工程师都需要具备的能力，尤其是写中间件的工程师。<br>这种情况下，压测基本上是驱动这个项目进化的源动力之一。也是业务方评判这个项目的优劣及适用性的一个很重要的标准，业界流行的 <code>redis</code>、<code>kafka</code>、<code>mongo</code>、<code>mysql</code>等这类中间件，都是直接在发行版中自带 benchmark 工具。<br>对打第 2 个问题，大多数时候需要链路压测。最常见的系统压测是基于 http 这类 “request/response” 的，而这也是测试工程师最常接触的。目标在于找到整个链路的性能峰值。<br>毫无疑问，在项目开发过程中，我们需要回答第 1 个问题，而往往这个问题需要研发工程师自己回答。但从实际的情况来看，对于大多数业务场景，这类问题是比较基础的问题，如果项目中有比较高级一些的研发工程师在技术评审时下点功夫，基本就能将这些问题扼杀在摇篮里。<br>也就意味着，业务系统做这类压测，原因往往有两个： 1. 技术管理体系不成熟，代码质量得不到保障。 2. 跟其他业务有所关联，需要自证。<br>如果要回答第 2 个问题，就需要链路压测，这也是最被大家所熟悉的压测，这类压测往往需要一个团队来执行，主要包含： 1. <code>测试工程师</code> 2. <code>运维工程师</code> 3. <code>研发工程师</code> 4. <code>业务人员(运营/产品)</code>。 在新项目上线、大促活动等情况下，一般需要做这类测试，用于保障线上不会被打垮。</p><h3 id="业界做的比较好的容量是怎样的"><a href="#业界做的比较好的容量是怎样的" class="headerlink" title="业界做的比较好的容量是怎样的"></a>业界做的比较好的容量是怎样的</h3><p>根据一些公开资料，有了解到使用机器学习的方式，得出各条件下对于机器资源的需求量。机器学习的来源，一方面是通过多次(很多)压测得到，另一方面，是通过线上实际数据反馈进行修正。<br>这样一套容量的机器学习方案确实是一个不错的选择，尤其是对于业务较多的企业，还是有不错的收益，例如阿里的本地生活就有这么一套。</p><h3 id="性能保障的职责"><a href="#性能保障的职责" class="headerlink" title="性能保障的职责"></a>性能保障的职责</h3><ol><li>由测试人员</li><li>由运维人员(sre)</li><li>由开发人员</li><li>由架构师</li></ol><p>对于常规的 http 请求的压测，可以由测试人员负责，凭借测试人员对业务场景的理解，可以构造出符合需求的测试脚本，再使用特定的压测工具，则可进行压测，压测的结果也比较清晰，可以直接交给相关项目的开发人员去进行接口优化。<br>针对特殊项目的压测，和普通意义上我们认为的测试工程师所做的工作不太一样，常规认为的测试工程师，大多凭借对业务场景的理解，加上对测试(功能/性能)工具的掌握，能做针对业务场景的测试/压测。这种项目的性能测试需要对这个项目本身比较熟悉，往往需要自行开发一些压测的工具来进行压测，从上述描述的测试工程师所擅长的技能来看，不能很好匹配。<br>对于链路压测，一般来说需要准备的内容比较复杂，包含 <code>压测目标确定</code>、<code>环境准备</code>、<code>压测场景构建</code>、<code>压测脚本</code>、<code>压测过程控制</code>、<code>项目配置/环境配置调整</code>、<code>压测资源监控</code>、<code>压测报告</code>、<code>压测结果分析</code> 等一系列环节。<br>这些环节过于复杂，对于任意一个工程师而言，都是几乎无法完成的。因此，往往需要一个团队来配合。团队内的分工大致如下：</p><ol><li>业务人员(产品/运营)，负责压测目标的确定(业务侧视角)。</li><li>测试人员，负责压测场景梳理、压测数据准备(协同研发人员)、压测执行、压测结果收集、压测报告</li><li>研发人员，负责standby问题排查、环境配置调整</li><li>运维人员，负责环境准备、协助排查资源问题</li><li>架构师/高级开发人员，负责压测结果报告分析、优化方案</li></ol></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/load-test/">load test</a> <a class="hover-with-bg" href="/longblog/tags/%E5%8E%8B%E6%B5%8B/">压测</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/21_12_02_operation_of_raid_with_lvm.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">使用lvm实现raid能力</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/21_09_30_to_think_what_is_the_important_things.html"><span class="hidden-mobile">梳理一下要做的重要的事</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>