<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>反穿技术哪家强? - Longbao</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="反穿技术哪家强?"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-12-11 17:35" pubdate>2021年12月11日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 22 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">反穿技术哪家强?</h1><div class="markdown-body"><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>有时候，因为种种原因，我们希望我们的机器能被其他一些原本访问不到我们的设备访问。<br>比如:</p><ol><li>做微信开发调试的时候，需要配置回调地址，也就是我们能访问微信的服务器，但微信的服务器需要访问我们时缺不行。</li><li>我们想要分享一些资料、文件、服务给不在同一个局域网的人。</li></ol><p>这些情况下，我们需要的技术方案，被称为 <code>内网穿透</code>。</p><h3 id="反穿可选方案"><a href="#反穿可选方案" class="headerlink" title="反穿可选方案"></a>反穿可选方案</h3><p>社区中，有很多这类工具。</p><h4 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h4><p>最简单的就是 ssh 的方案，只要开启了sshd，本地有ssh就能够实现，既然都在玩服务器了，又有几个没有 ssh 的呢。<br>使用起来非常简单：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> -R 和 -L 的差别只是翻转了，本身实现的效果是一样的</span><br>ssh -R 0.0.0.0:8081:0.0.0.0:8081 root@xx.xx.xx.xx<br></code></pre></td></tr></table></figure><p>上面这样，就把服务器的 8081 端口 代理到了本地的 8081。这个方案最大的优点就是 <code>简单</code> ，在调试时使用十分轻便。<br>问题有两个： 1. 不够稳定，容易断掉。 2. 只支持端口映射，更复杂的功能不好实现。</p><p>另外，ssh 其实是可以直接实现 socks 代理的，这样的目的在于，仅使用一个端口，就能实现对所有端口的访问：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> -f 为后台运行 -N 为不运行任何命令 -D 为动态代理  -q 为 quiet 模式</span><br>ssh  -qfND 0.0.0.0:1080 root@xxx.xx.xx.xx<br></code></pre></td></tr></table></figure><h4 id="autossh"><a href="#autossh" class="headerlink" title="autossh"></a>autossh</h4><p>对于ssh方案而言，最难搞的问题还是 <code>不稳定</code>，于是可以用 autossh 的方案解决。使用起来和 ssh 类似，不过多了一个监听端口：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">autossh -M 8082 -fNR 0.0.0.0:8081:0.0.0.0:8081 root@xx.xx.xx.xx<br></code></pre></td></tr></table></figure><p>这个方案最大的优势就是 解决了 ssh 断线重连的问题。因此，在开发调试时更加好用，而且 <code>-f</code> 参数支持了后台运行，比较优雅地解决了需要维持终端持续打开的问题。</p><p>基本上，在有一些临时性的穿透需求时，这个方案已经十分够用了。对于复杂功能的需求实际上不是这个工具要解决的问题，例如 udp、http、端口复用 等等。</p><h4 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h4><p>上面说的两种方案，主要是临时使用比较方便，但在功能的丰富度上还是十分不足的，毕竟 ssh 的主业是做加密登录的，端口映射只是副业。 而 frp 是则专门做内网穿透的。<br>如果希望提供比较稳定的内网穿透服务，那么选择 frp 就是比较好的选择了。</p><p>frp 分为 服务端 和 客户端，需要两端部署。通过 <code>.ini</code> 配置文件进行管理。支持 tcp、udp、http、ssl-tcp、ssl-udp、p2p 的配置，还对 http 代理做了一些优化(类似于 nginx 的一些功能)。</p><p>关于frp，官方文档介绍的肯定比我详细，可以参考 <a target="_blank" rel="noopener" href="https://gofrp.org/docs/">frp文档</a></p><h4 id="nps"><a href="#nps" class="headerlink" title="nps"></a>nps</h4><p>nps 和 frp 是同样定位的应用，两者在功能上也几乎一致，不过值得一提的是，nps自带官方的可视化管理页面，这点比frp在易用性上增加了不少(当然frp也有几个简单的社区版可视化工具)。</p><p>同样，详细可以参考 <a target="_blank" rel="noopener" href="https://ehang-io.github.io/nps/">nps文档</a></p><p>实际上，类似的工具还挺多，在 github 上还扒到另一个项目： <a target="_blank" rel="noopener" href="https://github.com/mmatczuk/go-http-tunnel">https://github.com/mmatczuk/go-http-tunnel</a> , 再比如和 nps 类似的 <a target="_blank" rel="noopener" href="https://github.com/inconshreveable/ngrok">ngrok</a> (ps: 这个项目1.0是开源的，2.0搞成商业项目了，然后1.0就不开发了，有nps代替基本可以不用关注这个项目了)</p><h3 id="一些其他的想法"><a href="#一些其他的想法" class="headerlink" title="一些其他的想法"></a>一些其他的想法</h3><p>上面说的 内网穿透，是解决网络通路的其中一种场景，除了上面这些方案，还有一些其他的方向，举些栗子：</p><h4 id="NAT映射"><a href="#NAT映射" class="headerlink" title="NAT映射"></a>NAT映射</h4><p>这种解决网络通路的方案，通常用在 <code>网关</code> 处，可以根据 网卡、ip、端口 做响应的转发。</p><h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><p>反向代理最常见的就是充当 <code>应用网关</code>，通过对 协议、域名、路径、header 等等做匹配，转发到内网中的不同服务上去。对于提供网络应用的软件来说，这种方式几乎是必然的。</p><p>传统应用中，最广泛的反向代理服务器就是 <code>nginx</code>。在云原生逐渐成长起来之后，ambassador、envoy、kong 等应用网关也顺势起飞了。</p><h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><p>对大众而言，最常接触到的解决网络通路的场景，还是 <code>代理</code>，为了和反向代理区分，我们不妨叫它 <code>正向代理</code>。</p><p>使用正向代理的场景很明确： 当我们的机器 A 无法访问机器 C，但是另一台机器 B 能访问机器 C，同时我们的机器 A 能访问机器 B，那么，机器 A 就可以让机器 B 代理 A 的请求，访问机器 C。</p><p>大众最常见的例子是，在国内，想要用手机看油管的视频，就需要安装代理软件。这个场景中，手机就是 机器A，油管的服务器就是机器 C，代理软件连接的服务端就是机器 B。</p><p>举个开发场景的例子：<br>公司开发环境的服务器A在公司内网，并且做了网络白名单，仅有特殊的网段能够访问，你的电脑不在这个特殊网段内，有一台机器B就在这个网段，你能访问这台机器 B，那么你就能通过机器 B 访问开发环境的服务器 A。通常，这个机器 B 可能是一个 <code>跳板机</code>，或者是一个 <code>vpn</code>。</p><p>我们通常认为，代理是为了解决 <code>网络不可达</code> 问题的，有些时候，代理也为了解决 <code>不那么可达</code> 的问题 ，俗称 <code>网速慢</code>。</p><p>比如在玩游戏这件事上，一些国外服的游戏，在国内玩起来就很慢，类似的还有看视频等场景。这种时候的代理，都是为了 <code>加速</code>，往往会采用 <code>udp</code> 的方案，可以参考 <a target="_blank" rel="noopener" href="https://github.com/wangyu-/UDPspeeder/blob/branch_libev/doc/README.zh-cn.md">UDPspeeder</a></p><p>如果要自己建立网络代理服务，最常见的方案是 <code>ss</code> 、<code>open VPN</code> , 这相关的资料网络上十分丰富，就不多说。<br>在 mac/windows/iphone/android 上安装代理客户端比较简单，但是在 linux 上安装代理客户端就相对不那么常见了，之前为了安装 helm，解决过在服务器上安装客户端的问题，详情可参考 <a href="/posts/21_month_day_%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3linux%E4%B8%8B%E7%9A%84%E4%BB%A3%E7%90%86%E8%AE%BF%E9%97%AE.html">linux上安装代理客户端</a></p><h3 id="网络相关的内容"><a href="#网络相关的内容" class="headerlink" title="网络相关的内容"></a>网络相关的内容</h3><p>网络连通性还有一些其他方面的，平常可能用得比较少。</p><h4 id="p2p"><a href="#p2p" class="headerlink" title="p2p"></a>p2p</h4><p>是 <code>peer to peer</code> 的缩写，现在最多的应用场景是 <code>p2p内容分发网络</code>，比如大家说的 <code>种子下载</code>。另外，在区块链上，也使用了相同的技术。另一种比较大众的应用场景，就是 <code>语音电话</code>、<code>视频电话</code> 。</p><p>p2p 用在私有领域，可以用来作为 安全通信 的技术方案，例如私有部署的即时通信。除了通信，还可以作为安全文件传输的方案，相关信息可以参考 <a target="_blank" rel="noopener" href="https://magic-wormhole.readthedocs.io/en/latest/welcome.html">magic-wormhole</a></p><h4 id="k8s-开发网络代理"><a href="#k8s-开发网络代理" class="headerlink" title="k8s 开发网络代理"></a>k8s 开发网络代理</h4><p>一般我们认为，要访问 k8s 中的服务，有这样几种方案：</p><ol><li>nodeport</li><li>loadbalancer</li><li>ingress</li></ol><p>在开发调试阶段，我们有时候想直接访问 k8s 中的服务，但是这个服务在 k8s 中仅有 ClusterIP，单独为这个服务创建 LB 也划不来，这时候可以使用 <code>kubectl port-forward [podname] [local port]:[pod port]</code>，如果遇到需要 port-forward 的数量比较多的时候，这种方式就比较麻烦了，此时需要批量转发，可以参考 <a target="_blank" rel="noopener" href="https://github.com/txn2/kubefwd">kubefwd</a>，也可以参考可视化的项目 <a target="_blank" rel="noopener" href="https://github.com/pixel-point/kube-forwarder">kube-forwarder</a></p><p>除了想在本地直接访问集群中的服务，有时候我们也想把集群中某个服务所收到的流量，转发到我们本地端口，这样就可以实现方便地调试。</p><p>我们目前使用的方案是 devspace，具体信息可以查看 <a target="_blank" rel="noopener" href="https://devspace.sh/cli/docs/introduction">devspace</a></p><p>其他可以考虑的方案可以查看</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/telepresenceio/telepresence">telepresence</a></li><li><a target="_blank" rel="noopener" href="https://github.com/omrikiei/ktunnel">ktunnel</a></li><li><a target="_blank" rel="noopener" href="https://nocalhost.dev/zh-CN/">nocalhost</a></li></ul></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/linux/">linux</a> <a class="hover-with-bg" href="/longblog/tags/proxy/">proxy</a> <a class="hover-with-bg" href="/longblog/tags/ssh/">ssh</a> <a class="hover-with-bg" href="/longblog/tags/frp/">frp</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/21_12_12_how_to_resolve_proxy_in_linux.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">如何解决linux下的代理访问</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/21_12_02_load_test_of_million_websocket_conns.html"><span class="hidden-mobile">websocket百万连接测试</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>