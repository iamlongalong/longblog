<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>记一次使用jupyter做数据分析 - Longbao</title><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/css/bootstrap.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/styles/github-gist.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/longblog/rss.xml" title="Longbao" type="application/atom+xml">
</head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="记一次使用jupyter做数据分析"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-04-13 11:47" pubdate>2023年4月13日 中午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.9k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 22 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">记一次使用jupyter做数据分析</h1><div class="markdown-body"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>因为工作需要，最近做了一次数据分析，用于洞察客户的使用情况及服务运行情况。</p><p>由于整个体系接触的比较少，因此做一下记录。</p><h2 id="数据分析的结构"><a href="#数据分析的结构" class="headerlink" title="数据分析的结构"></a>数据分析的结构</h2><p>在 <code>数据分析</code> 这项工作中，有如下环节：</p><ul><li>确认需求，明确想要分析的问题是什么，预期的产出是什么</li><li>确认数据源，明确数据的结构、格式、数据量等</li><li>确认数据逻辑，明确需要分析的问题所需数据是否到位</li><li>做数据预处理，数据清理、异构数据格式转换</li><li>查询的语句、分析的代码编写 (eg: sql、numpy 等)</li><li>数据可视化，图表绘制 (eg: BI 工具、excel、echarts、plotly 等)</li><li>数据结果的分析与说明 (eg: doc、slides、pdf 等)</li></ul><p>在本次的分析中，我的选择如下：</p><ul><li><p>确认需求： 分析客户基本特征、系统使用特征、磁盘空间占用分析</p></li><li><p>确认数据源： postgresql 数据库备份、du 结果文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@iZ2ze6jqzxxt4hf0qgpcglZ fordisk]<span class="hljs-comment"># ls -lh</span><br>total 13G<br>-rw-r--r-- 1 root root 1.1K Mar  7 21:50 df.log<br>-rwxr-xr-x 1 root root  292 Mar  7 21:42 getdiskusage.sh<br>-rw-r--r-- 1 root root  929 Mar  7 22:53 minio_disk_usage_info.log<br>-rw-r--r-- 1 root root 6.0G Mar  7 23:31 minio_disk_usage.log<br>-rw-r--r-- 1 root root 3.4G Apr  7 17:09 minio_disk_xx1.log<br>-rw-r--r-- 1 root root 3.4G Apr  7 17:16 minio_disk_xx2.log<br>-rw-r--r-- 1 root root  770 Mar  7 22:22 nfs_disk_usage_info.log<br></code></pre></td></tr></table></figure></li><li><p>确认数据逻辑： 分析 pg 数据库表结构及逻辑关系，确认 du 数据与业务含义<br><img src="https://static.longalong.cn/img/20230413123035.png" srcset="/longblog/static/img/loading.gif" lazyload></p></li><li><p>数据预处理： ① 对 pg 的数据做拆分聚合，形成多张能直接查询的表； ② 对 du 结果做处理，以关系数据的方式写入 pg 库中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">1. 去除 pg 中的无用数据<br>2. 使用 CREATE TABLE xxx AS SELECT * FROM xxx WHERE xx and xx; 的方式创建能直接使用的表<br>3. 写脚本将 du 的结果变成 csv 格式，并使用 COPY xxx FROM &#x27;xxx.csv&#x27;      WITH ( FORMAT csv, DELIMITER &#x27;,&#x27;, HEADER false); 导入到 pg 数据库<br></code></pre></td></tr></table></figure></li><li><p>查询的语句： 拆分需求所需的关键分析项，写 sql 查询，对查询结果做进一步处理得到所需结构。 工具上，使用 jupyterhub，所有操作均在 jupyter python note 中完成。<br><img src="https://static.longalong.cn/img/20230413123222.png" srcset="/longblog/static/img/loading.gif" lazyload></p></li><li><p>数据可视化： 根据需求，使用 pie、bar、line、heatmap、pareto 等图进行展示。 工具上，使用 plotly，直接在 jupyterhub 上生成图表。</p></li></ul><p><img src="https://static.longalong.cn/img/20230413121812.png" srcset="/longblog/static/img/loading.gif" lazyload alt="折线图"></p><p><img src="https://static.longalong.cn/img/20230413121831.png" srcset="/longblog/static/img/loading.gif" lazyload alt="柱形图"></p><p><img src="https://static.longalong.cn/img/20230413121915.png" srcset="/longblog/static/img/loading.gif" lazyload alt="帕累托图"></p><ul><li>数据结果的分析与说明： 直接使用 jupyterhub，使用 markdown 写结果分析。整个文件以 html 的方式导出图表和分析结果。<br><img src="https://static.longalong.cn/img/20230413123356.png" srcset="/longblog/static/img/loading.gif" lazyload></li></ul><h2 id="一些坑点-趣点小记"><a href="#一些坑点-趣点小记" class="headerlink" title="一些坑点/趣点小记"></a>一些坑点/趣点小记</h2><h3 id="jupyter-的导出问题"><a href="#jupyter-的导出问题" class="headerlink" title="jupyter 的导出问题"></a>jupyter 的导出问题</h3><p>按理，jupyter 是可以直接导出 pdf、html、slides 之类的，本想导出 pdf ，但要导出 pdf 需要各种插件依赖，我们的 jupyterhub 是用 centos 装的，依赖安装很难搞，建议用 ubuntu 装 jupyterhub。<br>最后无奈，只有导出 html ……</p><h3 id="note-的数据大小问题"><a href="#note-的数据大小问题" class="headerlink" title="note 的数据大小问题"></a>note 的数据大小问题</h3><p>一般而言，jupyterhub 要使用域名，就会在前面挡一层 nginx，我们也用的这种方式，但没有配置上传的 body 大小限制，默认是 1MB，超过就会报 413 错误，具体可以参考 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size">nginx 官方文档</a> ，可以设置为 20MB，大点的 note 也差不多在这之内。</p><h3 id="导出的-html-有点丑"><a href="#导出的-html-有点丑" class="headerlink" title="导出的 html 有点丑"></a>导出的 html 有点丑</h3><p>jupyter 导出的 html 既有 code 块 也有 输出块 (eg: 图表) 也有 文本块 (markdown)，但实际上对外分享时不需要 code 块，隐藏的方式在网上有一些用 plugin 的，简单尝试了下有点难搞，于是就在 html 的样式上下功夫，为了去掉 code 部分，添加了如下 style:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.jp-CodeMirrorEditor</span><span class="hljs-selector-class">.jp-Editor</span><span class="hljs-selector-class">.jp-InputArea-editor</span> &#123;<span class="hljs-attribute">display</span>: none;&#125;<br><span class="hljs-selector-class">.jp-InputArea</span><span class="hljs-selector-class">.jp-Cell-inputArea</span> &#123;<span class="hljs-attribute">display</span>: none;&#125;<br><span class="hljs-selector-class">.jp-OutputArea-child</span><span class="hljs-selector-pseudo">:has</span>(pre) &#123;<span class="hljs-attribute">display</span>: none;&#125;<br></code></pre></td></tr></table></figure><blockquote><p>不得不说， css 选择器中加了 has 这种能力后，父节点选择直接方便了不少</p></blockquote><p>另外，默认的字体大小为 14px，改了下 css 变量 <code>--jp-content-font-size1: 18px</code>，好看多了。</p><h3 id="sql-中直接做分组也挺方便"><a href="#sql-中直接做分组也挺方便" class="headerlink" title="sql 中直接做分组也挺方便"></a>sql 中直接做分组也挺方便</h3><p>除了常用的 <code>to_char(created_at::DATE, &#39;YYYY-MM-DD&#39;) as day</code> 、<code>date_trunc(&#39;week&#39;, created_at::date) as week</code> 这种时间分组操作外，还可以使用 <code>cross join lateral (values (max_kb / 1024)) xx (size_mb) GROUP BY xx.size_mb</code> 这种横向 join 的能力。</p><p>之前还有一些分组是在 python 脚本里手写的，但其实 sql、python 的 numpy 库中都可以直接做分组聚合，挺方便。</p><h3 id="结合-AI-？"><a href="#结合-AI-？" class="headerlink" title="结合 AI ？"></a>结合 AI ？</h3><p>很多数据分析其实都是很常规的，比如统计信息，一定程度上算得上是 <code>机械重复的工作</code> ，那么结合 AI 就是一个比较容易的事了。 相信很多团队都会在这个方向搞些事情，尤其是那些专门做 BI 工具的公司。(比如: power BI、tableau、神策？等)</p><p>从结合的方式来看，如果结合 AGI 例如 GPT，小团队使用还好，大团队的安全担忧会比较大。如果使用特定领域的 AI，那么问题就会变成 如何让 AI 理解业务结构的问题。会存在结构化或非结构化的方式，非结构化对应类似 GPT 的 prompt。</p><h3 id="jupyter-的-runtime-模式有点意思"><a href="#jupyter-的-runtime-模式有点意思" class="headerlink" title="jupyter 的 runtime 模式有点意思"></a>jupyter 的 runtime 模式有点意思</h3><p>jupyter 的特点主要是 code 和 markdown 的结合。当另外一点我认为也很有价值： runtime 保持。这对我们学习脚本语言的体验有很大提升，相当于一直处于断点模式，并且还可以随意修改下一个断点前的代码。</p><h3 id="其他的工具"><a href="#其他的工具" class="headerlink" title="其他的工具"></a>其他的工具</h3><p>在准备做这项事之前，花了一小段时间去调研用什么方式管理要做的事，最简单的例如：excel 图表 + 文档 的方式，这种方式管理起来很麻烦。于是想到了可以直接进行代码交互的方案，例如 jupyter notebook。 其实，这种工作属于 数据分析，而数据分析有更多专门的工具，主要的诉求有如下：</p><ol><li>连接各类数据库</li><li>对连接的数据源进行查询，并对结果做处理</li><li>生成图表</li><li>结果的分析记录</li><li>对外分享分析结论</li></ol><p>jupyter 算是一个比较通用的 python / nodejs 工具，但在数据分析方面的使用成本还是挺高的，例如连接数据库等等 (当然也有一些 jupyter 的插件能做到这件事)。</p><p>上面提到过的 power BI、tableau 在上手难度上很低，都属于面向分析人员的低代码方案。</p><p>不得不说，这其中还是存在一些需求的，市面上也确实看到过一些类似于 jupyter ，但是提升了在数据分析方面能力的工具，比如: <a target="_blank" rel="noopener" href="https://hex.tech/">hex</a> <a target="_blank" rel="noopener" href="https://observablehq.com/">observablehq</a> 。 <a target="_blank" rel="noopener" href="https://count.co/">count</a> 直接在 canvas 上操作，交互体验更有意思。还有开源的方案 <a target="_blank" rel="noopener" href="https://github.com/apache/zeppelin">zeppelin</a> 。</p><h2 id="更进一步"><a href="#更进一步" class="headerlink" title="更进一步"></a>更进一步</h2><h3 id="熟悉-numpy-的使用"><a href="#熟悉-numpy-的使用" class="headerlink" title="熟悉 numpy 的使用"></a>熟悉 numpy 的使用</h3><p>数据分析领域比较常用 python，主要是 python 下科学计算的库比较完善，比如 numpy，这次的分析中由于对 numpy 不熟悉，所以有些数据处理都是手写的，拉低了效率。</p><p>之后可以在 numpy 等工具应用上多看一下，同理 plotly。</p><h3 id="了解更多的数据分析方案"><a href="#了解更多的数据分析方案" class="headerlink" title="了解更多的数据分析方案"></a>了解更多的数据分析方案</h3><p>用 OLTP 关系数据库分析在少量数据时挺好用，但大数据量下性能就不大行了，比如千万级以上的数据，这种时候得使用其他方案了。</p><ul><li>数据库: clickhouse、hive、cassandra、hbase、mongodb、redis、rds……</li><li>分布式存储: hadoop(hdfs)、s3</li><li>stream: kafka、rocketmq、flume</li><li>任务与计算: flink、spark</li></ul><p>在数据分析之后，还有 AI 算法和模型训练，然后才能接上 AI</p><blockquote><p>调研过程中发现 <a target="_blank" rel="noopener" href="https://www.smartbi.com.cn/">smartbi</a> 在做类似的接入了~</p></blockquote><p>未来 20 年是 AI 的时代，拥抱数据分析、拥抱 AI</p><p><img src="https://static.longalong.cn/img/20230413135436.png" srcset="/longblog/static/img/loading.gif" lazyload></p><hr><blockquote><p>Ignorance never settles a question.<br>— <cite>Benjamin Disraeli</cite></p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/python/">python</a> <a class="hover-with-bg" href="/longblog/tags/jupyter/">jupyter</a> <a class="hover-with-bg" href="/longblog/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/23_04_25_16_40_record_of_collaboration_share_in_team.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">记一次协同问题的内部分享</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/23_04_06_21_41_some_questions_about_majors_in_university.html"><span class="hidden-mobile">关于职业规划的一些思考</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://static.longalong.cn/packages/blog/nprogress.min.js"></script><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://static.longalong.cn/packages/blog/jquery.min.js"></script><script src="https://static.longalong.cn/packages/blog/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://static.longalong.cn/packages/blog/tocbot.min.js"></script><script src="https://static.longalong.cn/packages/blog/jquery.fancybox.min.js"></script><script src="https://static.longalong.cn/packages/blog/anchor.min.js"></script><script defer src="https://static.longalong.cn/packages/blog/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://static.longalong.cn/packages/blog/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>