<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>redis实验环境搭建 - Longbao</title><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/css/bootstrap.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/longblog/rss.xml" title="Longbao" type="application/atom+xml">
</head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="redis实验环境搭建"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-11-11 21:24" pubdate>2022年11月11日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.3k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 14 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">redis实验环境搭建</h1><div class="markdown-body"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>redis 作为一个非常非常常用的缓存中间件，几乎应用于市面上 90% 以上的互联网公司。我们在学习 redis 时，需要环境来做实验，因此，记录搭建一下 redis 的环境，用作 handbook。</p><h2 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h2><p>本地的 redis 搭建直接参考 <a target="_blank" rel="noopener" href="https://github.com/iamlongalong/redis-instances">redis-instances</a> 即可，以下是项目的简介：</p><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>当我想要在本地用 redis cluster 做测试时，自然而然想到起个 docker ，但在 mac 上，这却非常难搞。</p><p>一番各种尝试之后，对其中的恶心深恶痛绝，遂希望建个小工具库，一来自己可以快速启动测试环境，二来也可以帮助遇到同样问题的码友们不遭受此罪，能把精力放到真正有价值的事上。</p><p>这是为了本地测试 redis cluster 而使用 docker-compose 启动的 6 节点 redis cluster。</p><h4 id="使用方式："><a href="#使用方式：" class="headerlink" title="使用方式："></a>使用方式：</h4><p>先执行 <code>./prepare.sh</code> ，这是为了准备 config 文件和 data 目录<br>再执行 <code>./run.sh</code>, 这将会启动 6 个 docker 容器，并将端口映射到主机<br>然后执行 <code>./cluster.sh</code>， 这会将 6 个节点组成 3主3从 的集群<br>当你确认不再使用后，使用 <code>./remove.sh</code> 删掉所有信息<br>redis 使用的官方的 6.0 版本。</p><p>组建好集群后，对集群进行验证：</p><p><code>redis-cli -c cluster info</code><br><code>redis-cli -c cluster nodes</code><br>如果要自己重新配置 <code>redis.conf</code>, 有以下需要注意：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">1. daemonize no    # 这个是 redis 后台运行的配置，docker 启动时不能后台运行，否则容器会退出导致启动失败<br>2. port $&#123;PORT&#125;    # 为了批量生成 redis.conf ， 使用了 envsubst 来渲染文件，如果使用不同 port ，则需要改成这样<br>3. dir &quot;/data&quot;     # 数据文件存放位置， 对应 docker-compose 中的 volume 挂载<br>4. logfile &quot;/data/redis.log&quot;  # 日志文件<br>5. bind &quot;0.0.0.0&quot;  # 需要暴露 port ，否则会组建集群失败<br>6. cluster‐enabled yes  # 集群模式需要打开该配置<br>7. cluster‐config‐file nodes.conf  # 集群信息文件，改不改名都可以，但默认为 nodes-6379.conf 容易误导<br>8. protected‐mode no  # 要外部访问，就需要把该模式关掉<br>9. appendonly yes   # 开启 aof 模式<br></code></pre></td></tr></table></figure><h3 id="docker-网络"><a href="#docker-网络" class="headerlink" title="docker 网络"></a>docker 网络</h3><p>docker 网络有几种模式，默认的是 bridge 模式，这种模式下，所有容器网络均由 docker0 这个网桥分配，容器相互访问可以通过 docker0 网桥转发。 一种是 host 网络，用的是主机网卡。 一种是 容器网络，可以多个容器共用一个网络空间，k8s 的 pause 容器就起这个作用。还有 overlay 网络、自定义网络(自定义的ip段等)。 我们最常用的是 bridge 网络，但这样有个问题，ip 的变动会导致一些有状态服务出问题。 于是，其中一种解决方法是 <code>--link</code> 模式，类似于给一个网络空间下加入了 服务名 ，可以解析到对应的 ip，但这种方式用起来比较麻烦。 另一种解决方案是 自定义网络，在指定了 subnet 之后，可以指定特定的 ip ，也可以指定 服务名，在存在多个服务时，是很常用的方式。 如果端口不冲突，使用同一个 <code>hostname</code> 也是不错的选择，例如 <code>--network=container:nginx01</code>。</p><p>在 redis-cluster 的场景中，我们有两个需求：</p><p>① 每个 redis 实例之间均可以通信<br>② 外部能访问每个 redis 实例。 前者是为了组集群，后者是为了外部访问。</p><p>这两个条件，有如下方案可行：</p><ol><li>直接使用 <code>host network</code>，每个 redis 实例使用不同端口。</li><li>直接使用 bridge 网络，通过 ip 访问，为了保证 脚本的确定性，可以使用自定义网络，并且指定 ip。</li></ol><p>这两种方案在 linux 下均可。</p><p>在 mac 上，由于实现方式的不同， mac 上无法直接访问 containerIP , 也无法使用 host network，可以参考 <a target="_blank" rel="noopener" href="https://github.com/docker/for-mac/issues/2670">docker/for-mac#2670</a> ， 所以在 mac 上就行不通了。</p><p>为了直接使用主机网络，有四种方案可以尝试：</p><p>直接在宿主机上运行 redis 进程，并使用不同端口。<br>使用 <code>-p</code> 暴露端口，并配置 subnet 指定容器 ip 和宿主机相同(多个容器共用，或者封装特定的多redis进程的镜像)。</p><p>配置 ss 进行代理，对特定网段的网络请求转发到由 ss 代理的 docker 网络中。<br>修改 redis-cluster 的组集群 ip 获取，改由环境变量传入。</p><p>这几种方式权衡下来，还是觉得直接在宿主机上运行 redis-cluster 的成本最低。</p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><p>既然做了 redis-cluster 的本地集群组建，那么回头再增加一些其他类型的资源组建，为他人学习、测试等提供便利。</p><ul><li><input checked disabled type="checkbox"> redis 主从组建 ✅ 2022-11-11</li><li><input checked disabled type="checkbox"> k8s 下的 redis 搭建 ✅ 2022-11-11</li><li><input checked disabled type="checkbox"> k8s 下的 redis-cluster 搭建 ✅ 2022-11-11</li><li><input disabled type="checkbox"> 增加 redis 性能测试的实验</li><li><input disabled type="checkbox"> redis 使用上的一些事儿</li></ul><hr><blockquote><p>Avoid having your ego so close to your position that when your position falls, your ego goes with it.<br>— <cite>Colin Powell</cite></p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/redis/">redis</a> <a class="hover-with-bg" href="/longblog/tags/redis-cluster/">redis-cluster</a> <a class="hover-with-bg" href="/longblog/tags/%E5%AE%9E%E9%AA%8C/">实验</a> <a class="hover-with-bg" href="/longblog/tags/%E7%8E%AF%E5%A2%83/">环境</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/22_11_12_00_17_simple_ways_in_log_collect_in_k8s.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">简单的集群日志采集方案</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/22_11_11_20_48_k8s_nfs_storage_class.html"><span class="hidden-mobile">nfs、localpath作为k8s-storage-class</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://static.longalong.cn/packages/blog/nprogress.min.js"></script><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://static.longalong.cn/packages/blog/jquery.min.js"></script><script src="https://static.longalong.cn/packages/blog/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://static.longalong.cn/packages/blog/tocbot.min.js"></script><script src="https://static.longalong.cn/packages/blog/jquery.fancybox.min.js"></script><script src="https://static.longalong.cn/packages/blog/anchor.min.js"></script><script defer src="https://static.longalong.cn/packages/blog/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://static.longalong.cn/packages/blog/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>