<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>alertmanager等监控项目源码走读 - Longbao</title><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/css/bootstrap.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/longblog/rss.xml" title="Longbao" type="application/atom+xml">
</head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="alertmanager等监控项目源码走读"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-02-09 15:14" pubdate>2023年2月9日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.8k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 19 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">alertmanager等监控项目源码走读</h1><div class="markdown-body"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在做私有部署的监控告警方案，由于我们线上用的是 promethues + alert manager + grafana 的方案，为了保持方案一致性，也使用了这套方案。</p><p>但在梳理需求的过程中，发现了一些其他的应用，具体可以查看:</p><ul><li><a href="/longblog/posts/23_02_15_01_04_easy_monitor_of_k8s_cluster.html" name="简单的集群监控方案">简单的集群监控方案</a></li><li><a href="/longblog/posts/22_11_06_00_54_health_check_and_monitor.html" name="WIP-健康检查与监控梳理">WIP-健康检查与监控梳理</a></li></ul><p>其中，发现 <a href="github.com/megaease/easeprobe">easeprobe</a> 和 <a target="_blank" rel="noopener" href="https://github.com/sourcegraph/checkup">checkup</a> 这两个项目还挺有意思，这和我们平常所认识的： promethues 、 zabbix、open-falcon、Nagios、datadog 等等不同。 这两个项目都是面向简单环境下的检查，很轻量，都是一个配置文件 + 一个二进制文件 即可运行起来。</p><p>在这里对 alertmanager 、easeprobe 、 checkup 做一次源码走读，看看有些什么可以借鉴的。</p><h2 id="整体认识"><a href="#整体认识" class="headerlink" title="整体认识"></a>整体认识</h2><p>对于监控告警而言，整体来说有这么几个核心概念：</p><ul><li>监控探测</li><li>探测数据存储</li><li>数据检查规则</li><li>告警分发<ul><li>告警组</li><li>告警渠道</li></ul></li><li>辅助系统<ul><li>api server</li><li>fontend admin page</li></ul></li></ul><p>以上是一个监控告警系统的核心环节，当然，在这之上可以添加很多辅助系统，例如用户系统、权限系统 等等。</p><h2 id="代码走读"><a href="#代码走读" class="headerlink" title="代码走读"></a>代码走读</h2><h3 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h3><h4 id="代码层级主体职能"><a href="#代码层级主体职能" class="headerlink" title="代码层级主体职能"></a>代码层级主体职能</h4><ul><li><p>cmd</p><ul><li>amtool<ul><li>这是 cli 的入口文件，详情可查看 cli 目录</li></ul></li><li>alertmanager<ul><li>这是 server 的直接入口文件</li><li>做一系列的初始化，例如： nflog(详见 nflog 目录)、cluster (详见 cluster 目录)、slience (详见 slience 目录)、mem provider (详见 provider 目录)、dispatch、api server (详见 api 目录)</li></ul></li></ul></li><li><p>config</p><ul><li>配置的 model，主要有 route (分发路由)、notifier (通知渠道)</li></ul></li><li><p>dispatch</p><ul><li>实现了 route 和分发逻辑。两个循环，① 循环接收 alerts ② 对每一个 alert 循环判断是否需要分发到 route。</li><li>聚合了 route(aggrGroup)、provider.Alerts、notify.Stage 等实例。</li></ul></li><li><p>api</p><ul><li>api server 的实现</li><li>restapi : 做了一个 http server 的封装，我们一般使用现成的框架，例如 gin、echo 等等。<ul><li>api： 具体业务接口的实现。</li><li>operations： 做了一些 params 和 response 的定义，看起来感觉实际意义不大。</li></ul></li><li>models : 接口的模型，做了 Validate 和 marshal 的逻辑，我们一般使用 tag 的方式做 validate，使用 http 框架提供的 bind 等做 marshal 操作。</li><li>client: 实际的 service 接口，业务方可直接使用作为 client sdk。</li></ul></li><li><p>notify</p><ul><li>通知的具体实现，有很多通知类型，写一些通知工具的时候可以参考： email、discord、opsgenie、pushover、slack、sns、telegram、webex、wechat……</li><li>扩展很方便，仅需要实现 Notify 接口即可。</li></ul></li><li><p>provider</p><ul><li>alerts 的暂存和分发，目前仅有 mem 的实现。</li></ul></li><li><p>store</p><ul><li>存储的实际实现，主体为一个 map 结构，有 gc。 provider 的 mem 中存的也是这个。</li></ul></li><li><p>silence</p><ul><li>静默的实现</li></ul></li><li><p>types</p><ul><li>几个公共的 model</li></ul></li><li><p>cluster</p><ul><li>集群实现</li></ul></li><li><p>cli</p><ul><li>提供一系列 cli 命令，主要是用于和 server 交互的，例如 添加告警、添加静默、获取状态 等等。</li><li>使用的 <a target="_blank" rel="noopener" href="https://github.com/alecthomas/kingpin">alecthomas/kingpin</a> cli 框架，我们平常用的是 cobra。</li></ul></li><li><p>timeinterval</p><ul><li>自己实现了一个时间周期判断器</li></ul></li><li><p>asset</p><ul><li>用的 github.com/shurcooL/httpfs 把静态资源打包到二进制文件中，保证了启动服务的简单。</li></ul></li><li><p>nflog</p><ul><li>每隔一段时间把接收到的 notify 情况进行 log 存储，用 proto 定义了 entry，存的也是 protocal buffer。</li></ul></li><li><p>ui</p><ul><li>管理面板的实现，前端项目，最后会打包到 assets 中。这种模式很方便，可以参考。</li></ul></li><li><p>把 proto 作为 model 使用</p><ul><li>cluster</li><li>nflog</li><li>slience</li></ul></li><li><p>使用二进制文件存数据</p><ul><li>nflog</li></ul></li><li><p>在网上看到这个，觉得不错</p></li></ul><p><img src="https://static.longalong.cn/img/20230220141634.png" srcset="/longblog/static/img/loading.gif" lazyload></p><h3 id="easeprobe"><a href="#easeprobe" class="headerlink" title="easeprobe"></a>easeprobe</h3><ul><li>channel : 消息通道，用来绑定探测和通知的</li><li>cmd : 服务的入口，做配置解析、绑定探测器、绑定通知 等等</li><li>conf : 全局的配置定义</li><li>daemon : 做 pidfile 管理，避免重复启动，没有重启能力</li><li>eval : 结果解析器，有 JSON、xml、text、html 等解析器，可以定义更丰富的结果判断方法</li><li>global : 定义一些全局变量</li><li>metric : 对接 promethues 指标</li><li>notify : 消息通知渠道，有很多种通知，可以参考<ul><li>base : 所有 notify 公共的字段和方法，继承 和 实现接口 是两种很通用的多态方式。</li></ul></li><li>probe : 探针的逻辑，最核心的部分<ul><li>data : 使用全局变量，保存所有探针结果。 status 为探针得出的结论。stat 为每次探测的记录。result 为当前探针的结果，包括了 status 和 stat 以及 探针本身的信息。</li><li>base : 探针的主题逻辑，使用 Config(probeFuc) 的方式实现多态，由各种探测方式自行进行探测，并返回结果给 base。</li></ul></li><li>report : 拼接各种报告模板</li><li>web : 提供 metrics 采集 和 报告获取接口</li></ul><p>整个服务实现得很简单清晰，很值得参考，主要有 ① 全局 config 的定义 ② 探针和 notify 的多态实现。</p><h3 id="checkup"><a href="#checkup" class="headerlink" title="checkup"></a>checkup</h3><ul><li>check : 提供了一些检查方式，有 http、tcp、tls、dns，还有 exec</li><li>cmd : 命令的入口文件<ul><li>采用了 cobra 的命令行框架</li><li>提供了几种执行探测的方式</li><li>serve : 提供了 web 服务，具体的前端代码在 statuspage 中</li></ul></li><li>notifier : 几种通知的方式<ul><li>每次检测 (每次检测可配置多次测试)，如果有错误就进行通知</li></ul></li><li>storage : 提供了多种存储方式，可用文件存储，也可用 sql 存储</li><li>types : 一些 model 的定义</li><li>checkup.go、notifier.go、storage.go 都是一些 model 的定义</li></ul><p>这个工具非常简单，把几个部分都拆得特别干净，相互没有依赖，也没有全局依赖，和上面两个不同的是，它完全采用了 无状态 设计，这让它可以实现分布式部署，所有数据都汇总到一个独立的地方，再对数据做聚合。</p><blockquote><p>吐槽一下，界面还是有点…… 🤦🏻‍♀️</p></blockquote><h2 id="简单思考"><a href="#简单思考" class="headerlink" title="简单思考"></a>简单思考</h2><p>这几个项目都比较简单，在梳理清楚 <code>工具的目标</code> 之后，实施起来实际上都不会特别麻烦。</p><p>但不同的开发者，看问题的视角和开发习惯都不完全相同，因此也有一些编程技巧是可以借鉴和学习的。</p><h3 id="你想得到什么？"><a href="#你想得到什么？" class="headerlink" title="你想得到什么？"></a>你想得到什么？</h3><p>这些都只是工具而已，看过了一遍代码也就过去了，关键还是得知道： 你究竟想得到什么？是否有战略目标？是否能把自己看到的这些东西融入到自己的一套体系中？</p><p>我希望得到：</p><ol><li>企业级业务系统可直接使用的监控方案</li><li>小项目可直接使用的监控方案</li></ol><h3 id="后续-TODO"><a href="#后续-TODO" class="headerlink" title="后续 TODO"></a>后续 TODO</h3><ul><li><del>走读 pushgateway 代码</del> <a href="/longblog/posts/23_02_09_23_45_code_reading_of_prometheus.html" name="prometheus代码走读">prometheus代码走读</a></li><li><del>走读 prometheus 代码</del> <a href="/longblog/posts/23_02_09_23_45_code_reading_of_prometheus.html" name="prometheus代码走读">prometheus代码走读</a></li><li><del>走读 prometheus client go 代码</del> (简单看了下，没什么特别说的)</li><li><del>完全走一次 promethues 的监控告警流程</del> <a href="/longblog/posts/23_02_15_01_04_easy_monitor_of_k8s_cluster.html#二进制部署" name="简单的集群监控方案">简单的集群监控方案</a></li><li>梳理在具体业务中使用 easeprobe 的场景<ul><li>考虑家用场景</li><li>考虑看板 和 ui 平台的价值</li></ul></li></ul><hr><blockquote><p>This is the final test of a gentleman: his respect for those who can be of no possible value to him.<br>— <cite>William Lyon Phelps</cite></p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/code-reading/">code reading</a> <a class="hover-with-bg" href="/longblog/tags/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">源码阅读</a> <a class="hover-with-bg" href="/longblog/tags/%E6%BA%90%E7%A0%81/">源码</a> <a class="hover-with-bg" href="/longblog/tags/alertmanager/">alertmanager</a> <a class="hover-with-bg" href="/longblog/tags/monitor/">monitor</a> <a class="hover-with-bg" href="/longblog/tags/easeprobe/">easeprobe</a> <a class="hover-with-bg" href="/longblog/tags/checkup/">checkup</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/23_02_11_18_15_code_reading_of_go_leveldb_and_others.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">golevelDB源码走读</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/23_03_07_23_16_some_platforms_on_k8s.html"><span class="hidden-mobile">关于k8s之上的一些平台的梳理</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://static.longalong.cn/packages/blog/nprogress.min.js"></script><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://static.longalong.cn/packages/blog/jquery.min.js"></script><script src="https://static.longalong.cn/packages/blog/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://static.longalong.cn/packages/blog/tocbot.min.js"></script><script src="https://static.longalong.cn/packages/blog/jquery.fancybox.min.js"></script><script src="https://static.longalong.cn/packages/blog/anchor.min.js"></script><script defer src="https://static.longalong.cn/packages/blog/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://static.longalong.cn/packages/blog/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>