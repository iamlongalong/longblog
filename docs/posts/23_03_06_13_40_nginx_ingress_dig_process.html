<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>记一次扒 nginx ingress 的过程 - Longbao</title><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/css/bootstrap.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/longblog/rss.xml" title="Longbao" type="application/atom+xml">
</head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="记一次扒 nginx ingress 的过程"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-03-06 13:40" pubdate>2023年3月6日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 62 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">记一次扒 nginx ingress 的过程</h1><div class="markdown-body"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近因为 nginx 网关的问题，导致服务有诸多不稳定的风险，因此需要更近一步去做网关的工作。</p><p>之前预判过将来会因无法自定义负载均衡而达不到目标，于是探索过 nginx-ingress 增加自定义负载均衡的方案，详情参见 <a href="/longblog/posts/22_3_23_a_record_of_balancing_stateful_service_explore.html" name="记一次有状态服务的负载均衡方案探索">记一次有状态服务的负载均衡方案探索</a> ，但由于当时业务还没有真正遇到问题，所以也没继续去推这个事儿。</p><p>不过当时的探索比较粗浅，是抱着 <code>能简单解决问题</code> 的目的做的，现在，需要有更多的梳理，以降低大家对这件事的认知复杂度。</p><h2 id="nginx-ingress"><a href="#nginx-ingress" class="headerlink" title="nginx ingress"></a>nginx ingress</h2><p>在 k8s 中，我们有多种提供对外访问的方式，其中业务中用的最多的，就是 ingress controller。 市面上提供的各类 ingress controller 非常多，例如 envoy、treafik、apisix、openresty 等等，我们选用的，是运维同学都比较熟悉的 nginx-ingress-controller。</p><blockquote><p>nginx 的官网参考 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/">nginx.org</a><br>nginx ingress controller 的官网参考 <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/">ingress-nginx</a> , <a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">github ingress-nginx</a></p></blockquote><p>先看一下 nginx ingress controller 的工作原理<br><img src="https://static.longalong.cn/img/20230306234451.png" srcset="/longblog/static/img/loading.gif" lazyload></p><p>在这个过程中，ingress-nginx 的职责是 <strong>接收 api-server 中的资源变化，并转化成 nginx 需要的格式，通过 http 发送给 nginx</strong></p><h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><p>nginx 依然是我们熟悉的那个 nginx，但是和传统我们使用的方式不同，所有资源变化的处理，全都是交给 <code>xxx_by_lua</code> ，包括我们本次最需要被扒的 <code>balancer</code> 。</p><p>balancer 的入口文件是 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/balancer.lua">lua/balancer.lua</a> ，可以看到有这样的内容：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> ngx_balancer = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;ngx.balancer&quot;</span>)<br><span class="hljs-keyword">local</span> round_robin = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;balancer.round_robin&quot;</span>)<br><span class="hljs-keyword">local</span> chash = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;balancer.chash&quot;</span>)<br><span class="hljs-keyword">local</span> chashsubset = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;balancer.chashsubset&quot;</span>)<br><span class="hljs-keyword">local</span> sticky_balanced = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;balancer.sticky_balanced&quot;</span>)<br><span class="hljs-keyword">local</span> sticky_persistent = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;balancer.sticky_persistent&quot;</span>)<br><span class="hljs-keyword">local</span> ewma = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;balancer.ewma&quot;</span>)<br><br><span class="hljs-keyword">local</span> DEFAULT_LB_ALG = <span class="hljs-string">&quot;round_robin&quot;</span><br><span class="hljs-keyword">local</span> IMPLEMENTATIONS = &#123;<br>  round_robin = round_robin,<br>  chash = chash,<br>  chashsubset = chashsubset,<br>  sticky_balanced = sticky_balanced,<br>  sticky_persistent = sticky_persistent,<br>  ewma = ewma,<br>&#125;<br><br><span class="hljs-keyword">local</span> _M = &#123;&#125;<br><span class="hljs-keyword">local</span> balancers = &#123;&#125;<br><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_implementation</span><span class="hljs-params">(backend)</span></span><br>  <span class="hljs-keyword">local</span> name = backend[<span class="hljs-string">&quot;load-balance&quot;</span>] <span class="hljs-keyword">or</span> DEFAULT_LB_ALG<br><br>  <span class="hljs-keyword">if</span> backend[<span class="hljs-string">&quot;sessionAffinityConfig&quot;</span>] <span class="hljs-keyword">and</span><br>     backend[<span class="hljs-string">&quot;sessionAffinityConfig&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>] == <span class="hljs-string">&quot;cookie&quot;</span> <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">if</span> backend[<span class="hljs-string">&quot;sessionAffinityConfig&quot;</span>][<span class="hljs-string">&quot;mode&quot;</span>] == <span class="hljs-string">&quot;persistent&quot;</span> <span class="hljs-keyword">then</span><br>      name = <span class="hljs-string">&quot;sticky_persistent&quot;</span><br>    <span class="hljs-keyword">else</span><br>      name = <span class="hljs-string">&quot;sticky_balanced&quot;</span><br>    <span class="hljs-keyword">end</span><br><br>  <span class="hljs-keyword">elseif</span> backend[<span class="hljs-string">&quot;upstreamHashByConfig&quot;</span>] <span class="hljs-keyword">and</span><br>         backend[<span class="hljs-string">&quot;upstreamHashByConfig&quot;</span>][<span class="hljs-string">&quot;upstream-hash-by&quot;</span>] <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">if</span> backend[<span class="hljs-string">&quot;upstreamHashByConfig&quot;</span>][<span class="hljs-string">&quot;upstream-hash-by-subset&quot;</span>] <span class="hljs-keyword">then</span><br>      name = <span class="hljs-string">&quot;chashsubset&quot;</span><br>    <span class="hljs-keyword">else</span><br>      name = <span class="hljs-string">&quot;chash&quot;</span><br>    <span class="hljs-keyword">end</span><br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-keyword">local</span> implementation = IMPLEMENTATIONS[name]<br>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> implementation <span class="hljs-keyword">then</span><br>    ngx.<span class="hljs-built_in">log</span>(ngx.WARN, backend[<span class="hljs-string">&quot;load-balance&quot;</span>], <span class="hljs-string">&quot; is not supported, &quot;</span>,<br>            <span class="hljs-string">&quot;falling back to &quot;</span>, DEFAULT_LB_ALG)<br>    implementation = IMPLEMENTATIONS[DEFAULT_LB_ALG]<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-keyword">return</span> implementation<br><span class="hljs-keyword">end</span><br><br><br><span class="hljs-built_in">setmetatable</span>(_M, &#123;<span class="hljs-built_in">__index</span> = &#123;<br>  get_implementation = get_implementation,<br>  sync_backend = sync_backend,<br>  route_to_alternative_balancer = route_to_alternative_balancer,<br>  get_balancer = get_balancer,<br>  get_balancer_by_upstream_name = get_balancer_by_upstream_name,<br>&#125;&#125;)<br><br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure><p>其核心作用，就是做 balancer 的注册及获取。</p><p>我们用的是 chash 的方式，对应的代码在 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/balancer/chash.lua">lua/balancer/chash.lua</a> ，内容如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> balancer_resty = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;balancer.resty&quot;</span>)<br><span class="hljs-keyword">local</span> resty_chash = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;resty.chash&quot;</span>)<br><span class="hljs-keyword">local</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;util&quot;</span>)<br><span class="hljs-keyword">local</span> ngx_log = ngx.<span class="hljs-built_in">log</span><br><span class="hljs-keyword">local</span> ngx_ERR = ngx.ERR<br><span class="hljs-keyword">local</span> <span class="hljs-built_in">setmetatable</span> = <span class="hljs-built_in">setmetatable</span><br><br><span class="hljs-keyword">local</span> _M = balancer_resty:new(&#123; factory = resty_chash, name = <span class="hljs-string">&quot;chash&quot;</span> &#125;)<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.new</span><span class="hljs-params">(self, backend)</span></span><br>  <span class="hljs-keyword">local</span> nodes = util.get_nodes(backend.endpoints)<br>  <span class="hljs-keyword">local</span> complex_val, err =<br>    util.parse_complex_value(backend[<span class="hljs-string">&quot;upstreamHashByConfig&quot;</span>][<span class="hljs-string">&quot;upstream-hash-by&quot;</span>])<br>  <span class="hljs-keyword">if</span> err ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>    ngx_log(ngx_ERR, <span class="hljs-string">&quot;could not parse the value of the upstream-hash-by: &quot;</span>, err)<br>  <span class="hljs-keyword">end</span><br><br>  <span class="hljs-keyword">local</span> o = &#123;<br>    instance = <span class="hljs-built_in">self</span>.factory:new(nodes),<br>    hash_by = complex_val,<br>    traffic_shaping_policy = backend.trafficShapingPolicy,<br>    alternative_backends = backend.alternativeBackends,<br>  &#125;<br>  <span class="hljs-built_in">setmetatable</span>(o, <span class="hljs-built_in">self</span>)<br>  <span class="hljs-built_in">self</span>.<span class="hljs-built_in">__index</span> = <span class="hljs-built_in">self</span><br>  <span class="hljs-keyword">return</span> o<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.balance</span><span class="hljs-params">(self)</span></span><br>  <span class="hljs-keyword">local</span> key = util.generate_var_value(<span class="hljs-built_in">self</span>.hash_by)<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.instance:<span class="hljs-built_in">find</span>(key)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure><p>其实这里面什么都没做，就是封装了一下 resty.chash ，继续扒一下这个库的源码 <a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-balancer/blob/master/lib/resty/chash.lua">openresty/lua-resty-balancer/lib/resty/chash.lua</a>，内容如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs lua">ffi.cdef<span class="hljs-string">[[</span><br><span class="hljs-string">typedef unsigned int uint32_t;</span><br><span class="hljs-string"></span><br><span class="hljs-string">typedef struct &#123;</span><br><span class="hljs-string">    uint32_t hash;</span><br><span class="hljs-string">    uint32_t id;</span><br><span class="hljs-string">&#125; chash_point_t;</span><br><span class="hljs-string"></span><br><span class="hljs-string">void chash_point_init(chash_point_t *points, uint32_t base_hash, uint32_t start,</span><br><span class="hljs-string">    uint32_t num, uint32_t id);</span><br><span class="hljs-string">int chash_point_sort(chash_point_t *points, uint32_t size);</span><br><span class="hljs-string"></span><br><span class="hljs-string">int chash_point_add(chash_point_t *old_points, uint32_t old_length,</span><br><span class="hljs-string">    uint32_t base_hash, uint32_t from, uint32_t num, uint32_t id,</span><br><span class="hljs-string">    chash_point_t *new_points);</span><br><span class="hljs-string">int chash_point_reduce(chash_point_t *old_points, uint32_t old_length,</span><br><span class="hljs-string">    uint32_t base_hash, uint32_t from, uint32_t num, uint32_t id);</span><br><span class="hljs-string">void chash_point_delete(chash_point_t *old_points, uint32_t old_length,</span><br><span class="hljs-string">    uint32_t id);</span><br><span class="hljs-string">]]</span><br><br><span class="hljs-keyword">local</span> _M = &#123;&#125;<br><br><span class="hljs-keyword">local</span> clib = load_shared_lib(<span class="hljs-string">&quot;librestychash&quot;</span>)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> clib <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">error</span>(<span class="hljs-string">&quot;can not load librestychash&quot;</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> CONSISTENT_POINTS = <span class="hljs-number">160</span>   <span class="hljs-comment">-- points per server</span><br><span class="hljs-keyword">local</span> pow32 = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>)<br><br><span class="hljs-keyword">local</span> chash_point_t = ffi.typeof(<span class="hljs-string">&quot;chash_point_t[?]&quot;</span>)<br><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_precompute</span><span class="hljs-params">(nodes)</span></span><br>	// 省略<br>    <span class="hljs-keyword">for</span> id, weight <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(nodes) <span class="hljs-keyword">do</span><br>		// 省略<br>        clib.chash_point_init(points, base_hash, start, num, index)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">if</span> clib.chash_point_sort(points, npoints) ~= CHASH_OK <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">error</span>(<span class="hljs-string">&quot;no memory&quot;</span>)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> ids, points, npoints, newnodes<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.new</span><span class="hljs-params">(_, nodes)</span></span><br>	// 省略<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.reinit</span><span class="hljs-params">(self, nodes)</span></span><br>	// 省略<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_delete</span><span class="hljs-params">(self, id)</span></span><br>	// 省略<br>    clib.chash_point_delete(<span class="hljs-built_in">self</span>.points, <span class="hljs-built_in">self</span>.npoints, index)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_incr</span><span class="hljs-params">(self, id, weight)</span></span><br>	// 省略<br>    <span class="hljs-keyword">local</span> base_hash = bxor(crc32(<span class="hljs-built_in">tostring</span>(id)), <span class="hljs-number">0xffffffff</span>)<br>    <span class="hljs-keyword">local</span> rc = clib.chash_point_add(<span class="hljs-built_in">self</span>.points, <span class="hljs-built_in">self</span>.npoints, base_hash,old_weight * CONSISTENT_POINTS, weight * CONSISTENT_POINTS,index, new_points)<br>	// 省略<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_decr</span><span class="hljs-params">(self, id, weight)</span></span><br>	// 省略<br>    <span class="hljs-keyword">local</span> rc = clib.chash_point_reduce(<span class="hljs-built_in">self</span>.points, <span class="hljs-built_in">self</span>.npoints, base_hash,from, num, index)<br><span class="hljs-keyword">end</span><br><br><br><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_find_id</span><span class="hljs-params">(points, npoints, hash)</span></span><br>    <span class="hljs-keyword">local</span> step = pow32 / npoints<br>    <span class="hljs-keyword">local</span> index = <span class="hljs-built_in">floor</span>(hash / step)<br><br>    <span class="hljs-keyword">local</span> max_index = npoints - <span class="hljs-number">1</span><br><br>    <span class="hljs-comment">-- it seems safer to do this</span><br>    <span class="hljs-keyword">if</span> index &gt; max_index <span class="hljs-keyword">then</span><br>        index = max_index<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-comment">-- find the first points &gt;= hash</span><br>    <span class="hljs-keyword">if</span> points[index].hash &gt;= hash <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">for</span> i = index, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span> <span class="hljs-keyword">do</span><br>            <span class="hljs-keyword">if</span> points[i - <span class="hljs-number">1</span>].hash &lt; hash <span class="hljs-keyword">then</span><br>                <span class="hljs-keyword">return</span> points[i].id, i<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br><br>        <span class="hljs-keyword">return</span> points[<span class="hljs-number">0</span>].id, <span class="hljs-number">0</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">for</span> i = index + <span class="hljs-number">1</span>, max_index <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> hash &lt;= points[i].hash <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">return</span> points[i].id, i<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> points[<span class="hljs-number">0</span>].id, <span class="hljs-number">0</span><br><span class="hljs-keyword">end</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.find</span><span class="hljs-params">(self, key)</span></span><br>    <span class="hljs-keyword">local</span> hash = crc32(<span class="hljs-built_in">tostring</span>(key))<br><br>    <span class="hljs-keyword">local</span> id, index = _find_id(<span class="hljs-built_in">self</span>.points, <span class="hljs-built_in">self</span>.npoints, hash)<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.ids[id], index<br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure><p>可以看到，这个文件实现了 <code>find</code> 的方法，而底层 hash 环维护的事交给了 <code>librestychash</code> 这个 clib，继续看一下 <a target="_blank" rel="noopener" href="https://github.com/openresty/lua-resty-balancer/blob/master/chash.c">openresty/lua-resty-balancer/chash.c</a>，代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">uint32_t</span> crc32_table256[] = &#123;<br>    <span class="hljs-number">0x00000000</span>, <span class="hljs-number">0x77073096</span>, <span class="hljs-number">0xee0e612c</span>, <span class="hljs-number">0x990951ba</span><br>    <span class="hljs-comment">// 省略……</span><br>&#125;;<br><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">crc32_update</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> *crc, u_char *p, <span class="hljs-keyword">size_t</span> len)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">uint32_t</span>  c;<br><br>    c = *crc;<br><br>    <span class="hljs-keyword">while</span> (len--) &#123;<br>        c = crc32_table256[(c ^ *p++) &amp; <span class="hljs-number">0xff</span>] ^ (c &gt;&gt; <span class="hljs-number">8</span>);<br>    &#125;<br><br>    *crc = c;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">chash_point_init_crc</span><span class="hljs-params">(<span class="hljs-keyword">chash_point_t</span> *arr, <span class="hljs-keyword">uint32_t</span> start, <span class="hljs-keyword">uint32_t</span> base_hash,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">uint32_t</span> from, <span class="hljs-keyword">uint32_t</span> num, <span class="hljs-keyword">uint32_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">chash_point_t</span> *node;<br>    <span class="hljs-keyword">uint32_t</span> i, hash;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-keyword">uint32_t</span>                        value;<br>        u_char                          byte[<span class="hljs-number">4</span>];<br>    &#125; prev_hash;<br><br>    prev_hash.value = <span class="hljs-number">0</span>;<br>    node = &amp;arr[start];<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; from + num; i++) &#123;<br>        hash = base_hash;<br>        crc32_update(&amp;hash, prev_hash.byte, <span class="hljs-number">4</span>);<br>        crc32_final(hash);<br><br>        <span class="hljs-keyword">if</span> (i &gt;= from) &#123;<br>            node-&gt;hash = hash;<br>            node-&gt;id = id;<br>            node = node + <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* no big performace different in my test */</span><br><br>        <span class="hljs-comment">/* this only works when have little endian */</span><br>        <span class="hljs-comment">// prev_hash.value = hash;</span><br><br>        prev_hash.byte[<span class="hljs-number">0</span>] = (u_char) (hash &amp; <span class="hljs-number">0xff</span>);<br>        prev_hash.byte[<span class="hljs-number">1</span>] = (u_char) ((hash &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>);<br>        prev_hash.byte[<span class="hljs-number">2</span>] = (u_char) ((hash &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>);<br>        prev_hash.byte[<span class="hljs-number">3</span>] = (u_char) ((hash &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span>);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">chash_point_init</span><span class="hljs-params">(<span class="hljs-keyword">chash_point_t</span> *arr, <span class="hljs-keyword">uint32_t</span> base_hash, <span class="hljs-keyword">uint32_t</span> start,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">uint32_t</span> num, <span class="hljs-keyword">uint32_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>    chash_point_init_crc(arr, start, base_hash, <span class="hljs-number">0</span>, num, id);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">chash_point_sort</span><span class="hljs-params">(<span class="hljs-keyword">chash_point_t</span> arr[], <span class="hljs-keyword">uint32_t</span> n)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">chash_point_t</span> *points;<br>    <span class="hljs-keyword">chash_point_t</span> *node;<br>    <span class="hljs-keyword">int</span> i, j, index, start, end;<br>    <span class="hljs-keyword">uint32_t</span> min_sz, m, step;<br><br>    <span class="hljs-comment">/* not sure 1.6 is the best */</span><br>    min_sz = n * <span class="hljs-number">1.6</span>;<br>    m = <span class="hljs-number">2</span>;<br><br>    <span class="hljs-keyword">while</span> (m &lt;= min_sz) &#123;<br>        m *= <span class="hljs-number">2</span>;<br>    &#125;<br><br>    step = <span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>) / m;<br><br>    points = (<span class="hljs-keyword">chash_point_t</span> *) <span class="hljs-built_in">calloc</span>(m, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">chash_point_t</span>));<br>    <span class="hljs-keyword">if</span> (points == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span> CHASH_ERR;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>        node = &amp;arr[i];<br>        index = node-&gt;hash / step;<br><br>        assert(index &lt; m); <span class="hljs-comment">// index must less than m</span><br><br>        <span class="hljs-keyword">for</span> (end = index; end &gt;= <span class="hljs-number">0</span>; end--) &#123;<br>            <span class="hljs-keyword">if</span> (points[end].id == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">goto</span> insert;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (node-&gt;hash &gt;= points[end].hash) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (start = end - <span class="hljs-number">1</span>; start &gt;= <span class="hljs-number">0</span>; start--) &#123;<br>            <span class="hljs-keyword">if</span> (points[start].id == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">/* left shift before end */</span><br>                <span class="hljs-keyword">for</span> (j = start; j &lt; end; j++) &#123;<br>                    points[j].hash = points[j + <span class="hljs-number">1</span>].hash;<br>                    points[j].id = points[j + <span class="hljs-number">1</span>].id;<br>                &#125;<br><br>                <span class="hljs-comment">/* points[end] is empty now */</span><br><br>                <span class="hljs-comment">/* left shift after end when node-&gt;hash is bigger than them */</span><br>                <span class="hljs-comment">/* only end == index can match this */</span><br>                <span class="hljs-keyword">while</span> (end + <span class="hljs-number">1</span> &lt; m<br>                       &amp;&amp; points[end + <span class="hljs-number">1</span>].id != <span class="hljs-number">0</span><br>                       &amp;&amp; points[end + <span class="hljs-number">1</span>].hash &lt; node-&gt;hash)<br>                &#123;<br>                    points[end].hash = points[end + <span class="hljs-number">1</span>].hash;<br>                    points[end].id = points[end + <span class="hljs-number">1</span>].id;<br>                    end += <span class="hljs-number">1</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">goto</span> insert;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">/* full before index, try to append */</span><br><br>        <span class="hljs-keyword">for</span> (end = end + <span class="hljs-number">1</span>; end &lt; m; end++) &#123;<br>            <span class="hljs-keyword">if</span> (points[end].id == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">goto</span> insert;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (node-&gt;hash &lt; points[end].hash) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (start = end + <span class="hljs-number">1</span>; start &lt; m; start++) &#123;<br>            <span class="hljs-keyword">if</span> (points[start].id == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">/* right shift */</span><br>        <span class="hljs-keyword">for</span> (j = start; j &gt; end; j--) &#123;<br>            points[j].hash = points[j - <span class="hljs-number">1</span>].hash;<br>            points[j].id = points[j - <span class="hljs-number">1</span>].id;<br>        &#125;<br><br>insert:<br>        assert(end &lt; m &amp;&amp; end &gt;= <span class="hljs-number">0</span>);<br><br>        points[end].id = node-&gt;id;<br>        points[end].hash = node-&gt;hash;<br>    &#125;<br><br>    j = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; m; i++) &#123;<br>        <span class="hljs-keyword">if</span> (points[i].id != <span class="hljs-number">0</span>) &#123;<br>            arr[j].id = points[i].id;<br>            arr[j].hash = points[i].hash;<br>            j++;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">free</span>(points);<br><br>    <span class="hljs-keyword">return</span> CHASH_OK;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">chash_point_add</span><span class="hljs-params">(<span class="hljs-keyword">chash_point_t</span> *old_points, <span class="hljs-keyword">uint32_t</span> old_length,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">uint32_t</span> base_hash, <span class="hljs-keyword">uint32_t</span> from, <span class="hljs-keyword">uint32_t</span> num, <span class="hljs-keyword">uint32_t</span> id,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">chash_point_t</span> *new_points)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, j, k;<br>    <span class="hljs-keyword">chash_point_t</span> *tmp_points;<br><br>    tmp_points = (<span class="hljs-keyword">chash_point_t</span> *) <span class="hljs-built_in">calloc</span>(num, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">chash_point_t</span>));<br>    <span class="hljs-keyword">if</span> (tmp_points == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-keyword">return</span> CHASH_ERR;<br>    &#125;<br><br>    chash_point_init_crc(tmp_points, <span class="hljs-number">0</span>, base_hash, from, num, id);<br><br>    <span class="hljs-keyword">if</span> (chash_point_sort(tmp_points, num) != CHASH_OK) &#123;<br>        <span class="hljs-built_in">free</span>(tmp_points);<br>        <span class="hljs-keyword">return</span> CHASH_ERR;<br>    &#125;<br><br>    j = num - <span class="hljs-number">1</span>;<br>    k = old_length + num - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (i = old_length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--, k--) &#123;<br>        <span class="hljs-keyword">while</span> (j &gt;= <span class="hljs-number">0</span> &amp;&amp; tmp_points[j].hash &gt; old_points[i].hash) &#123;<br>            new_points[k].hash = tmp_points[j].hash;<br>            new_points[k].id = tmp_points[j].id;<br><br>            j--;<br>            k--;<br>        &#125;<br><br>        new_points[k].hash = old_points[i].hash;<br>        new_points[k].id = old_points[i].id;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (; j &gt;= <span class="hljs-number">0</span>; j--, k--) &#123;<br>        new_points[k].hash = tmp_points[j].hash;<br>        new_points[k].id = tmp_points[j].id;<br>    &#125;<br><br>    <span class="hljs-built_in">free</span>(tmp_points);<br><br>    <span class="hljs-keyword">return</span> CHASH_OK;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">chash_point_reduce</span><span class="hljs-params">(<span class="hljs-keyword">chash_point_t</span> *old_points, <span class="hljs-keyword">uint32_t</span> old_length,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">uint32_t</span> base_hash, <span class="hljs-keyword">uint32_t</span> from, <span class="hljs-keyword">uint32_t</span> num, <span class="hljs-keyword">uint32_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, j, k;<br>    <span class="hljs-keyword">chash_point_t</span> *tmp_points;<br><br>    tmp_points = (<span class="hljs-keyword">chash_point_t</span> *) <span class="hljs-built_in">calloc</span>(num, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">chash_point_t</span>));<br><br>    chash_point_init_crc(tmp_points, <span class="hljs-number">0</span>, base_hash, from, num, id);<br><br>    <span class="hljs-keyword">if</span> (chash_point_sort(tmp_points, num) != CHASH_OK) &#123;<br>        <span class="hljs-built_in">free</span>(tmp_points);<br>        <span class="hljs-keyword">return</span> CHASH_ERR;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>, k = <span class="hljs-number">0</span>; i &lt; old_length; i++) &#123;<br>        <span class="hljs-keyword">if</span> (j &lt; num<br>            &amp;&amp; old_points[i].hash == tmp_points[j].hash<br>            &amp;&amp; old_points[i].id == id)<br>        &#123;<br>            j++;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i != k) &#123;<br>            old_points[k].hash = old_points[i].hash;<br>            old_points[k].id = old_points[i].id;<br>        &#125;<br>        k++;<br>    &#125;<br><br>    <span class="hljs-built_in">free</span>(tmp_points);<br><br>    <span class="hljs-keyword">return</span> CHASH_OK;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">chash_point_delete</span><span class="hljs-params">(<span class="hljs-keyword">chash_point_t</span> *old_points, <span class="hljs-keyword">uint32_t</span> old_length, <span class="hljs-keyword">uint32_t</span> id)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> i, j;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; old_length; i++) &#123;<br>        <span class="hljs-keyword">if</span> (old_points[i].id == id) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (i != j) &#123;<br>            old_points[j].hash = old_points[i].hash;<br>            old_points[j].id = old_points[i].id;<br>        &#125;<br>        j++;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这就是 chash 本身的实现了，比较简单，主要的结构如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-keyword">uint32_t</span> hash;<br>    <span class="hljs-keyword">uint32_t</span> id;<br>&#125; <span class="hljs-keyword">chash_point_t</span>;<br></code></pre></td></tr></table></figure><p>这是一个 point，理解成是 hash 环上的每一个桩就行了，整个 hash 环使用数组来实现。</p><h2 id="我们遇到的问题"><a href="#我们遇到的问题" class="headerlink" title="我们遇到的问题"></a>我们遇到的问题</h2><h3 id="背景场景"><a href="#背景场景" class="headerlink" title="背景场景"></a>背景场景</h3><p>使用的 ingress-nginx 做应用网关，应用中有一个 websocket 的服务，会有大量的连接保持着。 同时，为了让缓存发挥作用，我们使用了 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash">nginx consistent hash</a> 的方式让同一个 room 下的连接在同一个 pod 上。</p><p>存在隐患的场景有如下 2 个:</p><ol><li><p>当 ingress 发生变化，<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#worker-shutdown-timeout">ingress-nginx</a>会在<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/ngx_core_module.html#worker_shutdown_timeout">一段时间后</a>强制停止 worker 进程。这会导致短时间内大量 websocket 重新连接，无异于一次攻击 🐶 ……</p></li><li><p>当服务进行更新部署时，若采用大批量更新，则会导致短时间大量重连，和场景 1 有异曲同工之效；若采用小批量滚动更新，则会导致部分用户会进行多次重连。</p></li></ol><h3 id="可能的思路"><a href="#可能的思路" class="headerlink" title="可能的思路"></a>可能的思路</h3><h4 id="能否让-hash-环不发生变化？"><a href="#能否让-hash-环不发生变化？" class="headerlink" title="能否让 hash 环不发生变化？"></a>能否让 hash 环不发生变化？</h4><p>从 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/balancer/chash.lua">nginx-ingress/lua/chash.lua</a> 中可以看到，hash 环生成的方式是以 endpoints 为基准的，如果 endpoints 不发生改变，则 hash 环不会发生改变。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.new</span><span class="hljs-params">(self, backend)</span></span><br>  <span class="hljs-keyword">local</span> nodes = util.get_nodes(backend.endpoints)<br>  // 省略……<br>  <span class="hljs-keyword">return</span> o<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>ep 是每一个 pod 的 ip，会随着 pod 的更新而更新，所以答案几乎是否定的。(当然还是有一些奇怪的操作可以达到目标，但不常规操作还是少搞的好，不然就是大坑一个)</p><h4 id="能否让负载均衡可控？"><a href="#能否让负载均衡可控？" class="headerlink" title="能否让负载均衡可控？"></a>能否让负载均衡可控？</h4><p>嗯，这个自然是可以的，基本 demo 可以查看 <a href="/longblog/posts/22_3_23_a_record_of_balancing_stateful_service_explore.html" name="记一次有状态服务的负载均衡方案探索">记一次有状态服务的负载均衡方案探索</a></p><p>当然，为了让整套体系能够起作用，还需要做大量的体系性工作，之前有一个简单的 demo，可以查看 <a href="/longblog/posts/23_03_05_23_01_a_record_of_sharing_of_k8s.html#part2: 如何用 operator 玩点有意思的事" name="记录一次在团队内的k8s分享">用 operator 做点有趣的事</a></p><p>这里可以更细致地做一些原型出来</p><h4 id="能不能让网关重启不会导致连接断掉？"><a href="#能不能让网关重启不会导致连接断掉？" class="headerlink" title="能不能让网关重启不会导致连接断掉？"></a>能不能让网关重启不会导致连接断掉？</h4><p>按照调研，目前市面上能看到 mosn 是做了连接平滑迁移的，这里去看一下，它具体是怎么做到的，有什么优劣？</p><p>mosn 的代码地址： <a target="_blank" rel="noopener" href="https://github.com/mosn/mosn">https://github.com/mosn/mosn</a><br>一篇关于 mosn 是怎么做的迁移： <a target="_blank" rel="noopener" href="https://mosn.io/blog/posts/nginx-envoy-mosn-hot-upgrade/">nginx vs envoy vs mosn 平滑升级原理</a></p><p>基本结论是： mosn 和 envoy 都使用了 UDS (unix domain sockets) 的技术，这是在 linux 内核 3.5+ 支持的一种文件描述符传递的方案。</p><p>追了一下 mosn 的代码，核心逻辑如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">// transferHandler is called on recv transfer request</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">transferHandler</span><span class="hljs-params">(c net.Conn, handler types.ConnectionHandler, transferMap *sync.Map)</span></span> &#123;<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> &#123;<br>			log.DefaultLogger.Errorf(<span class="hljs-string">&quot;[network] [transfer] [handler] transferHandler panic %v&quot;</span>, r)<br>		&#125;<br>	&#125;()<br><br>	<span class="hljs-keyword">defer</span> c.Close()<br><br>	uc, ok := c.(*net.UnixConn)<br>	<span class="hljs-keyword">if</span> !ok &#123;<br>		log.DefaultLogger.Errorf(<span class="hljs-string">&quot;[network] [transfer] [handler] unexpected FileConn type; expected UnixConn, got %T&quot;</span>, c)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// recv type</span><br>	conn, err := transferRecvType(uc)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.DefaultLogger.Errorf(<span class="hljs-string">&quot;[network] [transfer] [handler] transferRecvType error :%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> conn != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">// transfer read</span><br>		<span class="hljs-comment">// recv header + buffer</span><br>		dataBuf, tlsBuf, err := transferReadRecvData(uc)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			log.DefaultLogger.Errorf(<span class="hljs-string">&quot;[network] [transfer] [handler] transferRecvData error :%v&quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		connection := transferNewConn(conn, dataBuf, tlsBuf, handler, transferMap)<br>		<span class="hljs-keyword">if</span> connection != <span class="hljs-literal">nil</span> &#123;<br>			transferSendID(uc, connection.id)<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			transferSendID(uc, transferErr)<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// transfer write</span><br>		<span class="hljs-comment">// recv header + buffer</span><br>		id, buf, err := transferWriteRecvData(uc)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			log.DefaultLogger.Errorf(<span class="hljs-string">&quot;[network] [transfer] [handler] transferRecvData error :%v&quot;</span>, err)<br>		&#125;<br>		connection := transferFindConnection(transferMap, <span class="hljs-keyword">uint64</span>(id))<br>		<span class="hljs-keyword">if</span> connection == <span class="hljs-literal">nil</span> &#123;<br>			log.DefaultLogger.Errorf(<span class="hljs-string">&quot;[network] [transfer] [handler] transferFindConnection failed, id = %d&quot;</span>, id)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		err = transferWriteBuffer(connection, buf)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			log.DefaultLogger.Errorf(<span class="hljs-string">&quot;[network] [transfer] [handler] transferWriteBuffer error :%v&quot;</span>, err)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>关于具体细节的问题，可以再细致看一下代码，或者调试一下。</p><p>关于转移连接描述符的操作，代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 老的，发送 fd</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">transferSendFD</span><span class="hljs-params">(uc *net.UnixConn, file *os.File)</span> <span class="hljs-title">error</span></span> &#123;<br>	buf := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">byte</span>, <span class="hljs-number">1</span>)<br>	<span class="hljs-comment">// transfer read</span><br>	buf[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>	<span class="hljs-keyword">if</span> file == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;transferSendFD conn is nil&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">defer</span> file.Close()<br>	rights := syscall.UnixRights(<span class="hljs-keyword">int</span>(file.Fd()))<br>	n, oobn, err := uc.WriteMsgUnix(buf, rights, <span class="hljs-literal">nil</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;WriteMsgUnix: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> n != <span class="hljs-built_in">len</span>(buf) || oobn != <span class="hljs-built_in">len</span>(rights) &#123;<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;WriteMsgUnix = %d, %d; want 1, %d&quot;</span>, n, oobn, <span class="hljs-built_in">len</span>(rights))<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 新的，接收 fd</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">transferRecvFD</span><span class="hljs-params">(oob []<span class="hljs-keyword">byte</span>)</span> <span class="hljs-params">(net.Conn, error)</span></span> &#123;<br>	scms, err := unix.ParseSocketControlMessage(oob)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;ParseSocketControlMessage: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(scms) != <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;expected 1 SocketControlMessage; got scms = %#v&quot;</span>, scms)<br>	&#125;<br>	scm := scms[<span class="hljs-number">0</span>]<br>	gotFds, err := unix.ParseUnixRights(&amp;scm)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unix.ParseUnixRights: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(gotFds) != <span class="hljs-number">1</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;wanted 1 fd; got %#v&quot;</span>, gotFds)<br>	&#125;<br>	f := os.NewFile(<span class="hljs-keyword">uintptr</span>(gotFds[<span class="hljs-number">0</span>]), <span class="hljs-string">&quot;fd-from-old&quot;</span>)<br>	<span class="hljs-keyword">defer</span> f.Close()<br>	conn, err := net.FileConn(f)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;FileConn error :%v&quot;</span>, gotFds)<br>	&#125;<br>	<span class="hljs-keyword">return</span> conn, <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>这里可以画一下流程图，可能更好理解一些。</p><h4 id="能否使用-UDS-解决业务升级问题？"><a href="#能否使用-UDS-解决业务升级问题？" class="headerlink" title="能否使用 UDS 解决业务升级问题？"></a>能否使用 UDS 解决业务升级问题？</h4><p>实现上当然是 ok 的，但不建议这么搞，主要有以下原因：</p><ul><li>业务不是网关，代码的稳定性是很不好的，需要经常变更，为了满足隐藏的一些需求，还是在业务层做特定机制的建设更好。</li><li>我们的服务都运行在容器中，对 k8s 而言，镜像是不可变的，平滑升级导致我们在不可变的镜像中使用了可变的进程，容易出问题。</li></ul><h3 id="我们究竟要解决什么问题？"><a href="#我们究竟要解决什么问题？" class="headerlink" title="我们究竟要解决什么问题？"></a>我们究竟要解决什么问题？</h3><ul><li>让大规模重连尽量不要发生<ul><li>网关独立，不被其他对网关的改动而影响</li><li>使用能平滑迁移的网关，如 mosn</li><li>业务应用平滑启动<ul><li>少量 pod 滚动更新<ul><li>坏处: 部分连接会多次重连(这里涉及 ws 服务目前均衡的具体实现，需要再细看代码) ；</li><li>好处: 对数据库的压力较小 ；</li><li>要解决的问题: ws 服务本身会不会被突然重连的压力搞出问题 =&gt; 加多一些 vnode</li></ul></li><li>蓝绿发布、连接迁移</li></ul></li></ul></li><li>让大规模重连也不会引发重大问题<ul><li>session 机制 (这个我觉得还是很有效的)</li><li>考虑用 redis、甚至内存 的方式做连接信息管理</li><li>限流降级熔断机制<ul><li>网关层限流等</li><li>业务层限流等</li><li>前端自身限流等 (至少不要疯狂重连吧 😂 )</li></ul></li></ul></li><li>其他可能的问题<ul><li>再细致地查一查，经常断掉是怎么发生的，会不会是心跳机制的问题</li><li>内存泄漏和协程泄漏往往是同时发生的，是不是可以把协程池弄上，然后监控起来</li><li>前端的策略还是有很多可讨论的，比如 长期在后台的页面，是不是把连接断了不要连了</li><li>多个连接的价值需不需要再探讨一下？ (不一定，紧要性不高)</li><li>每天晚上的几千个连接还是有点问题的，查一查心里稳妥些</li></ul></li></ul><blockquote><p>实际上，我们可能主要的问题还是 mongodb 索引少建了一个，在此基础上或许一切的问题都是可以堆一点资源就解决的 🐶 ……<br>业务有时候就是这样，解决问题或许比牛逼的技术有更大业务价值……</p></blockquote><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol><li>openresty 库中还有很多实用的工具，之后有机会可以详细扒一下，例如:</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs text">├── aes.lua<br>├── chash.lua<br>├── cookie.lua<br>├── core<br>│   ├── base.lua<br>│   ├── base64.lua<br>│   ├── ctx.lua<br>│   ├── exit.lua<br>│   ├── hash.lua<br>│   ├── misc.lua<br>│   ├── ndk.lua<br>│   ├── phase.lua<br>│   ├── regex.lua<br>│   ├── request.lua<br>│   ├── response.lua<br>│   ├── shdict.lua<br>│   ├── time.lua<br>│   ├── uri.lua<br>│   ├── utils.lua<br>│   ├── var.lua<br>│   └── worker.lua<br>├── core.lua<br>├── limit<br>│   ├── conn.lua<br>│   ├── count.lua<br>│   ├── req.lua<br>│   └── traffic.lua<br>├── md5.lua<br>├── random.lua<br>├── roundrobin.lua<br>├── sha.lua<br>├── sha1.lua<br>├── sha224.lua<br>├── sha256.lua<br>├── sha384.lua<br>├── sha512.lua<br>├── string.lua<br>└── upload.lua<br></code></pre></td></tr></table></figure><ol start="2"><li><p>另一个常用的负载方式是 chashsubset ，实现在 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/blob/main/rootfs/etc/nginx/lua/balancer/chashsubset.lua">chashsubset.lua</a> ，后续可以继续扒一下</p></li><li><p>mosn 的实现中还有很多可以参考的地方，比如 wasm 的扩展方式、xprotocal 的扩展方式，看看还是有价值的</p></li></ol><hr><blockquote><p>Anticipate the difficult by managing the easy.<br>— <cite>Laozi</cite></p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/code-reading/">code reading</a> <a class="hover-with-bg" href="/longblog/tags/nginx/">nginx</a> <a class="hover-with-bg" href="/longblog/tags/nginx-ingress/">nginx ingress</a> <a class="hover-with-bg" href="/longblog/tags/ingress/">ingress</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/23_03_09_12_53_some_research_of_file_storage.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">关于文件存储的一些调研</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/23_03_05_23_01_a_record_of_sharing_of_k8s.html"><span class="hidden-mobile">记录一次在团队内的k8s分享</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://static.longalong.cn/packages/blog/nprogress.min.js"></script><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://static.longalong.cn/packages/blog/jquery.min.js"></script><script src="https://static.longalong.cn/packages/blog/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://static.longalong.cn/packages/blog/tocbot.min.js"></script><script src="https://static.longalong.cn/packages/blog/jquery.fancybox.min.js"></script><script src="https://static.longalong.cn/packages/blog/anchor.min.js"></script><script defer src="https://static.longalong.cn/packages/blog/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://static.longalong.cn/packages/blog/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>