<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>service mesh 是如何产生的？ - Longbao</title><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/css/bootstrap.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/longblog/rss.xml" title="Longbao" type="application/atom+xml">
</head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="service mesh 是如何产生的？"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-03-05 16:07" pubdate>2023年3月5日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.9k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 20 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">service mesh 是如何产生的？</h1><div class="markdown-body"><h3 id="演进过程"><a href="#演进过程" class="headerlink" title="演进过程"></a>演进过程</h3><p>最原始的应用，是由小团队直接负责的单体应用，直观的感受是，团队里的每个人，都对整个项目的技术选型具有影响力(姑且认为 每个人都是 “技术管理委员会” 的成员)。由于仅有一个大项目，也就基本不存在 “平台能力” 的概念。</p><p>单体项目逐渐膨胀，分层逐渐模糊、模块逐渐耦合、调用逐渐混乱、发布越发频繁、单个错误的影响面越发增大…… ，这就进入到所谓的 “单体地狱” 阶段。 解决办法之一，就是进行 服务化演进。</p><h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><p>当单体服务拆分成多个服务后，从代码功能上，出现了一系列 与业务功能无关的 相似需求，例如 <code>服务发现</code>、<code>配置管理</code>、<code>负载均衡</code>、<code>健康检查</code>、<code>限流熔断</code>、<code>安全加密</code>、<code>协议转换</code>、<code>认证授权</code>、<code>链路追踪</code>、<code>通用监控</code> 等，我们将之统称为 “平台能力”。</p><p>在组织结构上，不同的服务 会被 不同的团队(人员) 所管理，服务的技术走向 会逐渐脱离原有的 “技术管理委员会” 的管理，逐渐出现 不同代码实现、不同库选型、不同框架选型、不同语言选型 等等情况。</p><p>当出现了一些上述的问题后，有识之士 就会想： <strong>“如何统一提供平台能力，解放业务专家们，让业务同学专注业务开发？”</strong></p><h3 id="解决问题的方向"><a href="#解决问题的方向" class="headerlink" title="解决问题的方向"></a>解决问题的方向</h3><h4 id="进程内方案"><a href="#进程内方案" class="headerlink" title="进程内方案"></a>进程内方案</h4><p>最直接的想法会是：根据不同语言，提供平台能力的 sdk。表现形式可能是： 工具库、应用框架。例如，统一的 web server 框架，在框架中提供 服务发现、负载均衡、监控、限流 等平台能力。</p><p>举个栗子，java 中的 <code>spring cloud</code> 提供了几大组件解决平台能力，如： <code>Eureka</code> 解决服务注册与发现、 <code>Ribbon</code> 解决负载均衡、 <code>Hystrix</code> 解决系统保护、 <code>Gateway</code> 提供 api 网关、 <code>Spring cloud config</code> 解决配置管理……</p><p>实际上，在单个语言体系下的各类 微服务框架 都是在解决这个问题。例如 golang 下的 <code>kratos</code>、<code>go-zero</code>、<code>go-micro</code>、<code>rpcx</code>、<code>kitex</code>、<code>go-kit</code> 等。(每个语言下都有一大堆)</p><p>但这种方式也存在 2 个主要问题：</p><ol><li>如果使用了多个语言体系，那么代码的维护成本就需要 *N 。例如，一个 负载均衡 的能力，如果有 python、java、golang、nodejs 4种语言，就需要对应的开发团队维护 4 套代码。难度之大，难以想象。 这个假设，其实是建立在一些 <code>大型团队</code>、<code>历史包袱重</code> 的前提下的。 对于大多数中小团队，服务端其实也只有一个语言体系，因此不失为一个不错的方案。</li><li>当平台能力不够稳定时(其实几乎很难稳定)，平台能力的升级需要业务代码同步更新，而推动业务同学进行库的升级，在稍大点的团队中是十分费心费力的。这也就是 代码耦合 带来的弊端。</li></ol><h4 id="进程外方案"><a href="#进程外方案" class="headerlink" title="进程外方案"></a>进程外方案</h4><p>在遇到上面的问题后，自然而然的想法，就是将一些平台能力进行抽离，在单独的进程中运行。独立部署后，使用一系列进程间通信的方式提供平台能力，就解决了 “语言绑定” 和 “代码绑定” 的问题。就这样，sidecar 模式诞生了！</p><p>Sidecar 在解决一些问题的同时，自然也引入了一些问题，主要有两个：</p><ol><li>通信方式的问题。</li><li>性能的问题。</li></ol><p>性能问题，从全局来看，由于多了一层进程外处理流程，不可避免地肯定会有性能损耗。解决办法自然就是尽量降低 sidecar 本身处理的资源耗用，包括 语言选型使用更高性能的语言(如 go、c++ 等)、代码层的架构设计和实现优化、扩展点使用更高性能的实现 (例如 grpc、wasm、golang、lua 等)。</p><p>通信方式 有两个走向：</p><ol><li>业务完全透明 的流量劫持 模式。</li><li>提供 http/grpc 的通信模式。</li></ol><h3 id="side-car-一览"><a href="#side-car-一览" class="headerlink" title="side car 一览"></a>side car 一览</h3><p>目前社区中比较出彩的 sidecar 解决平台能力的方案有： <a target="_blank" rel="noopener" href="https://konghq.com/kong-mesh">kong(kuma)</a>、<a target="_blank" rel="noopener" href="https://github.com/istio/istio">istio(envoy)</a>、<a target="_blank" rel="noopener" href="https://github.com/traefik/mesh">traefik-mesh</a>、<a target="_blank" rel="noopener" href="https://docs.nginx.com/nginx-service-mesh">nginx mesh (不开源)</a>、<a target="_blank" rel="noopener" href="https://github.com/linkerd/linkerd2">linkerd</a>、 <a target="_blank" rel="noopener" href="https://github.com/dapr/dapr">dapr</a> 、<a target="_blank" rel="noopener" href="https://github.com/mosn/mosn">mosn</a>、<a target="_blank" rel="noopener" href="https://github.com/megaease/easegress">easegress</a> 、<a target="_blank" rel="noopener" href="https://github.com/hashicorp/consul">consul</a> 、<a target="_blank" rel="noopener" href="https://github.com/openservicemesh/osm">osm(envoy)</a></p><p>从上面的项目可以看出，sidecar 大多都是从 <code>网关</code> 延伸而来的，这和 <code>平台能力</code> 的主体 <code>流量治理</code> 是分不开关系的。 基础能力是要做到 <code>服务发现</code>、<code>负载均衡</code>、<code>路由</code>、<code>安全</code>，延伸能力有 <code>限流熔断</code>、<code>可观测性(metrics、tracing)</code> 、<code>流量灰度</code>、<code>故障注入</code>、<code>认证授权</code>、<code>协议转换</code>、<code>管理平台</code> 。</p><p>所有上面这些项目，有一个比较特殊： <code>dapr</code>，其他的基本都是 <code>网关</code>，而 dapr 被认为是一个 <code>应用运行时</code>，之所以 dapr 也被我列到这里，是因为他们有很多相似的地方，例如：<code>路由</code> 、<code>服务发现</code>、<code>负载均衡</code>、<code>可观测性</code> 等。</p><p>现在看起来不一样的地方，例如 dapr 提供 <code>kvstore(state)</code>、<code>pubsub</code> 等，目标是提供与平台无关(不太相关) 的特定能力，例如 kvstore 就提供了 <code>DynamoDB</code> 、<code>redis</code>、<code>postgresql</code> 等实现。 从一部分 service mesh 的项目发展方向来看 (envoy、mson等)，流量代理的类型从原有的 <code>tcp</code>、<code>http</code>、<code>ws</code>、<code>http2</code>、<code>grpc</code> 等协议，扩展至 <code>redis</code>、<code>mongodb</code>、<code>dynamodb</code>、<code>kakfa</code>、<code>dubbo</code> 甚至是 自定义 协议(自有 rpc 协议) 的代理。</p><p>有了这类中间件的代理，自然而然就会想着做些什么，比如 抽象一些通用业务能力，在代理中进行一些特定处理……， 这样，也就和 dapr 殊途同归了……</p><h3 id="趋势"><a href="#趋势" class="headerlink" title="趋势"></a>趋势</h3><p>可以看到一个趋势，随着技术需求的逐渐固化，开发模式逐渐靠近 <code>更加通用</code>、<code>更加透明</code>、<code>更加傻瓜式</code> 的设计理念，不论是各类开发框架提供的 <code>开箱即用 的开发套件</code>，还是类似于 grpc 提供的 <code>rpc client server 代码生成能力</code>， 亦或是各类脚手架工具提供的 <code>http 基础代码、orm 代码 一键生成</code> 能力，还是 基础设施层提供的 <code>流量代理side car</code> 流量治理能力，以及还未怎么普及的 <code>应用运行时</code>(eg: dapr)。</p><p>可以认为，基础设施所追求的一个目标是： <strong>极大地 降低业务人员的心智负担， 让业务人员 回归 业务开发！</strong> 。</p><h3 id="我们可以做些什么？"><a href="#我们可以做些什么？" class="headerlink" title="我们可以做些什么？"></a>我们可以做些什么？</h3><p>为了实现这个目标，我们可以无所不用其极。例如：</p><ul><li>在一定程度上，选择一套完善的开发框架，能够完成业务开发的需要 (http server、log、api、orm)；</li><li>选择一套部署方案，能够快速准备环境，部署应用 (gitlab、k8s 等)；</li><li>选择一套通用基础设施，以及对应的管理平台 (mysql、redis、kafka 等)；</li><li>选择一系列通用工具，例如 功能测试、接口测试、压测、低代码平台、yapi、k8s 调试工具(devspace 等)、oauth平台、账户中心、rbac 等等；</li></ul><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>实际上，<code>dapr</code> 的设计思想，和 <code>baas</code> 有着密不可分的联系。当我们盘点一下 baas 所提供的能力，例如 文档存储、事件通知 ，就会发现，和 dapr 提供的 state 管理、pub/sub(binding) 相对应。</p><h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><p><a target="_blank" rel="noopener" href="https://philcalcado.com/2017/08/03/pattern_service_mesh.html">Pattern: Service Mesh</a><br><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/785943">Dapr 在阿里云原生的实践-阿里云开发者社区</a><br><a target="_blank" rel="noopener" href="https://mosn.io/blog/posts/multi-protocol-deep-dive/">MOSN 多协议机制解析</a><br><a target="_blank" rel="noopener" href="https://www.servicemesher.com/envoy/intro/what_is_envoy.html">Envoy 是什么? · Envoy proxy中文文档</a></p></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/istio/">istio</a> <a class="hover-with-bg" href="/longblog/tags/service/">service</a> <a class="hover-with-bg" href="/longblog/tags/service-mesh/">service mesh</a> <a class="hover-with-bg" href="/longblog/tags/linkerd/">linkerd</a> <a class="hover-with-bg" href="/longblog/tags/sidecar/">sidecar</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/22_3_25_some_kinds_of_communication_in_backends.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">几种后端通信方式的杂谈</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/22_11_21_21_12_how_to_prepare_a_private_deploy_env.html"><span class="hidden-mobile">如何搞定一个基础的私有部署环境</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://static.longalong.cn/packages/blog/nprogress.min.js"></script><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://static.longalong.cn/packages/blog/jquery.min.js"></script><script src="https://static.longalong.cn/packages/blog/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://static.longalong.cn/packages/blog/tocbot.min.js"></script><script src="https://static.longalong.cn/packages/blog/jquery.fancybox.min.js"></script><script src="https://static.longalong.cn/packages/blog/anchor.min.js"></script><script defer src="https://static.longalong.cn/packages/blog/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://static.longalong.cn/packages/blog/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>