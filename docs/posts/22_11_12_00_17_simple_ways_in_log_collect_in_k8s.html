<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>简单的集群日志采集方案 - Longbao</title><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/css/bootstrap.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/styles/github-gist.min.css"><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/longblog/rss.xml" title="Longbao" type="application/atom+xml">
</head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="简单的集群日志采集方案"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-11-12 00:17" pubdate>2022年11月12日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 1.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 15 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">简单的集群日志采集方案</h1><div class="markdown-body"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>当一个程序运行时，为了掌握程序的运行情况，我们需要对程序进行日志采集。无论是传统的机器部署，还是基于 k8s 的服务部署，日志采集的整体逻辑是一样的： ① 日志落盘 ② 日志采集 ③ 日志处理 ④ 日志存储 ⑤ 日志展示 ⑥ 日志归档</p><p>本文，我们一起搭建一套简单的日志采集体系。</p><h2 id="日志流程"><a href="#日志流程" class="headerlink" title="日志流程"></a>日志流程</h2><h3 id="日志落盘"><a href="#日志落盘" class="headerlink" title="日志落盘"></a>日志落盘</h3><ul><li>传统部署</li></ul><p>传统服务运行时，可以通过将日志写到一个目录下的文件中。</p><blockquote><p>TODO: 跑通一个日志库的完整使用</p></blockquote><ul><li>k8s</li></ul><p>stdout 直接输出到容器日志文件</p><h3 id="日志采集"><a href="#日志采集" class="headerlink" title="日志采集"></a>日志采集</h3><ul><li>filebeat</li><li>fluent-bit/fluentd (详细见实操 <a href="/longblog/posts/22_11_12_00_17_simple_ways_in_log_collect_in_k8s.html#实操" name="简单的集群日志采集方案">简单的集群日志采集方案</a>)</li></ul><h3 id="日志处理"><a href="#日志处理" class="headerlink" title="日志处理"></a>日志处理</h3><ul><li>logstash</li><li>fluent-bit</li></ul><h3 id="日志存储"><a href="#日志存储" class="headerlink" title="日志存储"></a>日志存储</h3><ul><li>es</li><li>loki</li></ul><h3 id="日志展示"><a href="#日志展示" class="headerlink" title="日志展示"></a>日志展示</h3><ul><li>kibana</li></ul><h3 id="日志归档"><a href="#日志归档" class="headerlink" title="日志归档"></a>日志归档</h3><ul><li>es-rotate (这块儿流程跑一下)</li></ul><h3 id="基于日志的告警"><a href="#基于日志的告警" class="headerlink" title="基于日志的告警"></a>基于日志的告警</h3><ul><li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/current/alerting-getting-started.html">kibana-alert</a> (elastic watcher)</li></ul><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li><input disabled type="checkbox"> 找一套轻量的日志采集方案</li></ul><h2 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h2><h3 id="fluentd-k8s-实操"><a href="#fluentd-k8s-实操" class="headerlink" title="fluentd k8s 实操"></a>fluentd k8s 实操</h3><p>由于集群的日志都会在当前机器的文件系统存放，所以实际上只需要起一个 fluentd 进程，并且能够读取日志目录即可。</p><p>如果在集群中，则需要以下操作： ① 启动 fluentd 的进程容器 ② 把 k8s 日志目录挂到容器中。 为了解决对 每台机器 的日志采集，需要采用部署中的 daemonset。</p><p>另外，由于一些插件可能会用到集群信息，需要给部署集绑定集群角色。</p><p>具体可以查看： <a target="_blank" rel="noopener" href="https://docs.fluentd.org/quickstart">fluentd 的官方文档</a></p><p>实际的部署文件如下： (参考<a target="_blank" rel="noopener" href="https://github.com/fluent/fluentd-kubernetes-daemonset">官方案例</a>)</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;namespaces&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;pods&quot;</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;get&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;watch&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;list&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">input.conf:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    &lt;source&gt;</span><br><span class="hljs-string">      @type tail</span><br><span class="hljs-string">      tag k8s.fluentd.log.*</span><br><span class="hljs-string">      path /var/log/containers/*.log</span><br><span class="hljs-string">      pos_file /var/log/k8s.fluentd.log.pos</span><br><span class="hljs-string">      refresh_interval 3s</span><br><span class="hljs-string">      read_from_head true</span><br><span class="hljs-string">      rotate_wait 30s</span><br><span class="hljs-string">      &lt;parse&gt;</span><br><span class="hljs-string">        @type regexp</span><br><span class="hljs-string">        expression ^(?&lt;time&gt;[^ ]+) (?&lt;stream&gt;stdout|stderr) (?&lt;logtag&gt;[^ ]*) (?&lt;log&gt;.*)$</span><br><span class="hljs-string">        time_type string</span><br><span class="hljs-string">        time_format %Y-%m-%dT%H:%M:%S.%N%z</span><br><span class="hljs-string">        localtime true</span><br><span class="hljs-string">        keep_time_key true</span><br><span class="hljs-string">      &lt;/parse&gt;</span><br><span class="hljs-string">    &lt;/source&gt;</span><br><span class="hljs-string"></span><br>  <span class="hljs-comment"># 这些都是根据自己的情况配置，可以输出到文件、到es、到kafka、到logstash等,具体配置可以查看 [官方文档](https://docs.fluentd.org/output/file)</span><br>  <span class="hljs-attr">output.conf:</span> <span class="hljs-string">|-</span><br><span class="hljs-string">    &lt;match k8s.**&gt;</span><br><span class="hljs-string">      @type file</span><br><span class="hljs-string">      path /xxx/log</span><br><span class="hljs-string">      add_path_suffix true</span><br><span class="hljs-string">      path_suffix &quot;.log&quot;</span><br><span class="hljs-string">      append true</span><br><span class="hljs-string">      &lt;format&gt;</span><br><span class="hljs-string">        @type json</span><br><span class="hljs-string">      &lt;/format&gt;</span><br><span class="hljs-string">      &lt;buffer tag&gt;</span><br><span class="hljs-string">        @type file</span><br><span class="hljs-string">        path /xx/log/fluentd.log.buffer</span><br><span class="hljs-string">        chunk_limit_size 8MB</span><br><span class="hljs-string">        total_limit_size 64MB</span><br><span class="hljs-string">        flush_mode interval</span><br><span class="hljs-string">        flush_interval 1s</span><br><span class="hljs-string">        retry_max_interval 30</span><br><span class="hljs-string">        retry_forever true</span><br><span class="hljs-string">        flush_thread_count 4</span><br><span class="hljs-string">      &lt;/buffer&gt;</span><br><span class="hljs-string">    &lt;/match&gt;</span><br><span class="hljs-string"></span><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">seccomp.security.alpha.kubernetes.io/pod:</span> <span class="hljs-string">&#x27;docker/default&#x27;</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">priorityClassName:</span> <span class="hljs-string">system-node-critical</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">fluentd</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">fluent/fluentd-kubernetes-daemonset:v1.15-debian-forward-amd64-1</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">FLUENTD_ARGS</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">--no-supervisor</span> <span class="hljs-string">-q</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">limits:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">3Gi</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">100Mi</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/fluent/config.d</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">outputlog</span><br>          <span class="hljs-attr">mountPath:</span> &#123;&#123; <span class="hljs-string">EXT_K3S_LOG_PATH</span> &#125;&#125;<br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">30</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">outputlog</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> &#123;&#123; <span class="hljs-string">EXT_K3S_LOG_PATH</span> &#125;&#125;<br></code></pre></td></tr></table></figure><h3 id="fluentbit-k8s-实操"><a href="#fluentbit-k8s-实操" class="headerlink" title="fluentbit k8s 实操"></a>fluentbit k8s 实操</h3><p>fluentd 是一个 ruby + c 的实现，可能还是有些问题吧，主要是多了一些系统依赖，于是又搞了一个 纯c 写的 fluentbit， 这有<a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/about/fluentd-and-fluent-bit">官方文档</a>写的两者的关系和差别。 fluentd 的缺点是有 ruby 的环境依赖，优点是拥有 1000+ plugins。 fluentbit 的缺点是目前仅有 70+ 插件，优点是无环境依赖，一个二进制就可以跑。</p><p>k8s 使用 helm 部署，可以直接参考 <a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/installation/kubernetes">官方文档</a>， 这是默认的 <a target="_blank" rel="noopener" href="https://github.com/fluent/helm-charts/blob/main/charts/fluent-bit/values.yaml">values.yaml</a></p><p>对于一个日志采集器而言，主要就是配置这么几个环节(管道)：</p><ul><li><a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/pipeline/inputs">input</a>: 用于配置从何处采集日志，例如文件夹、http、mqtt 等等</li><li><a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/pipeline/parsers/json">parser</a>: 处理拿到的日志格式，例如 把 docker 日志处理成 json、把 ng 日志处理成 json 等等。</li><li><a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/pipeline/filters/modify">filter</a>: 过滤操作，可以修改、添加一些信息，例如加 pod name 之类的。</li><li><a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/pipeline/outputs/elasticsearch">output</a>: 日志的输出，可以是 kafka、file、es、nats</li></ul><p>值得一提的是，fluentbit 支持用 golang build 成 lib 的方式，具体可以参考 <a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/development/golang-output-plugins">官方文档</a></p><hr><blockquote><p>Life is really simple, but we insist on making it complicated.<br>— <cite>Confucius</cite></p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/operation/">operation</a> <a class="hover-with-bg" href="/longblog/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a> <a class="hover-with-bg" href="/longblog/tags/k8s/">k8s</a> <a class="hover-with-bg" href="/longblog/tags/log/">log</a> <a class="hover-with-bg" href="/longblog/tags/%E6%97%A5%E5%BF%97/">日志</a> <a class="hover-with-bg" href="/longblog/tags/elk/">elk</a> <a class="hover-with-bg" href="/longblog/tags/efk/">efk</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/22_11_16_12_05_what_is_share_card.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">sharecard是什么？</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/22_11_11_21_24_redis_enviroment.html"><span class="hidden-mobile">redis实验环境搭建</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://static.longalong.cn/packages/blog/nprogress.min.js"></script><link rel="stylesheet" href="https://static.longalong.cn/packages/blog/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://static.longalong.cn/packages/blog/jquery.min.js"></script><script src="https://static.longalong.cn/packages/blog/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://static.longalong.cn/packages/blog/tocbot.min.js"></script><script src="https://static.longalong.cn/packages/blog/jquery.fancybox.min.js"></script><script src="https://static.longalong.cn/packages/blog/anchor.min.js"></script><script defer src="https://static.longalong.cn/packages/blog/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://static.longalong.cn/packages/blog/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>