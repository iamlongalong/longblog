<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/longblog/static/img/favicon.png"><link rel="icon" href="/longblog/static/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="longalong"><meta name="keywords" content=""><title>prometheus代码走读 - Longbao</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/longblog/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/longblog/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"iamlongalong.github.io",root:"/longblog/",version:"1.8.11",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/static/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}},search_path:"/local-search.xml"}</script><script src="/longblog/js/utils.js"></script><script src="/longblog/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/longblog/rss.xml" title="Longbao" type="application/atom+xml">
</head><body><header style="height:35vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/longblog/">&nbsp;<strong>Longbao</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/longblog/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/longblog/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/longblog/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/longblog/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/longblog/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/longblog/static/img/default.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="prometheus代码走读"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> longalong </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-03-05 23:45" pubdate>2023年3月5日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 25 分钟</span></div></div><div class="scroll-down-bar"><i class="iconfont icon-arrowdown"></i></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">prometheus代码走读</h1><div class="markdown-body"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>prometheus 还是很牛逼的，作为云原生监控系统的事实标准，值得一读。</p><p>生态中对应的还有 AlertManager、pushgateway、operator，之前已经走读过 alertManager 的代码，详见 <a href="/longblog/posts/23_02_09_15_15_code_reading_of_alert_manager.html" name="alertmanager等监控项目源码走读">alertmanager等监控项目源码走读</a>， 这里，走读一下 pushgateway 和 prometheus 的代码。</p><h2 id="代码走读"><a href="#代码走读" class="headerlink" title="代码走读"></a>代码走读</h2><h3 id="pushgateway"><a href="#pushgateway" class="headerlink" title="pushgateway"></a>pushgateway</h3><ul><li>main.go : 解析参数，启动 server。 http server 用的 promethues 包中的，这在 alertManager 中是一样的。</li><li>handler : 实现各种接口处理, 用闭包的方式，避免了一些全局变量的使用，例如 logger。<ul><li>支持 protobuf 的 encoding 方式，model 在 prometheus 的 client 中定义的 MetricFamily</li><li>使用 parser.TextToMetricFamilies 解析 prometheus 的值</li><li>status.go 中使用了 tempate，并注入了 func，这种方式在一些简单的场景下很好用，毕竟不是所有项目都适合上一套前端框架。</li></ul></li><li>storage : 存储的实现，用的 disk 做存储，存储格式直接用的 gob，在直接存储对象上，非常方便。</li><li>asset : 将 ui 打包到二进制中。</li></ul><p>这个项目的功能和结构虽然都非常简单，但却有很多值得参考的地方，尤其是 使用 gob 直接存对象的方式、直接在 http 接口中使用 protobuf 做解析、将 asset 直接打包到 二进制中、简单场景直接使用 template……</p><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><ul><li>cmd : 入口文件，处理 config bind、validate、init，启动服务等。 promtool 提供了 cli 和 prometheus 交互的方式。</li><li>discovery : 抓取的 targets 管理<ul><li>targetGroup 代表一组 target endpoint，而在 scrape.target 中的 Target 则是一个具体的 endpoint。这里可能比较难理解 target 的 url 从哪里来，在 scrape.target.Target.URL() 中可以看到，host、metrics_path 都在 label 中，是特定的 label。</li><li>manager.go : manager 管理接收到的新的 endpoints (map[poolKey]map[string]*targetgroup.Group)，在 startProvider 中对接管道。 provider 是实际的 metrics 的提供者，他们关心 endpoints 的变化。discovery 是发现变化的，例如 file、k8s、zk、http 等。</li><li>registry.go : 使用注册方式，由 config 生成实际的 discovery，然后注册到中心的 hub 中。 类似于 builder 的方式，生成的 discovery 通过 Run() 方法启动。 这种做法很通用，在 grpc 的各种包里也有同样的操作。</li><li>kubernetes.go<ul><li>使用 cache informer 可以减轻对 k8s api server 的压力，这里的代码参考有价值</li><li>使用 workqueue，把接收到的消息异步处理，避免 event 处理的时序错误。</li></ul></li><li>xds.go : 说是 xds，实际上是 kuma，因为 kuma 是基于 envoy 的，而 xds 则是 envoy 的 discoverys。 这块儿可以进一步看下 envoy 的东西。</li><li>在类似于 http、dns、docker 等方式中，因为没有<code>监听</code>的能力，因此抽象了一个 refresh 的 discovery wrapper。</li></ul></li><li>model : 在业务中使用的模型，包括处理方法。 核心模型定义在 prompb 中。<ul><li>rulefmt : 告警规则的模型</li><li>textparse : 有三种格式，text 格式、proto buffer、openmetrics。结合 go_client 可以拿到 metrics_family。 text 格式的代码是一个不错的词法解析器的参考，另外的参考可以看 go-zero 对 proto 文件的解析。 (当然 promql 也是)</li><li>histogram : 一个 histogram 的实现。</li></ul></li><li>prompb : 核心模型定义</li><li>notifier<ul><li>对 alertmanager 的管理，也有 discovery 的能力，具体在 discovery.legacymanager 中。</li><li>逻辑很简单，Send() 方法吧所有 alerts 存到 queue 中，然后触发 sendall() 。</li><li>接受来自 rule 包的 alerts。</li></ul></li><li>plugins : 目前是注册 discovery 的。</li><li>rules<ul><li>告警规则管理，连接 promql 和 alertmanager。</li><li>分组 (Group)，每个组有一系列具体的监控规则 (rule)，使用 interval 做周期控制，使用 promql 做判断。</li><li>recording.go : 具体的判断 rule (expr)</li><li>alerting.go : alert 的具体状态</li></ul></li><li>scrape<ul><li>抓取 metrics 的具体实现。分 scrape pool 进行抓取，具体的控制过程在 scrapeLoop.scrapeAndReport 中。</li><li>用了 buffer pool 做 bytes 复用。毕竟发起的请求数量很多，可以减少 gc 压力。 具体的 pool 实现在 util.pool 中，可以参考下，这个 pool 做了分 bucket。</li><li>用了 label cache 来保证同一个指标的 label 可以复用而不用重新初始化。</li><li>抓取到数据后的具体的处理逻辑在 scrape.scrapeLoop.append 中，主要是解析指标，并且给 appender 发送数据， appender 是从 scrape.Manager 中传进来的，具体实现在 storage.fanout 中。</li></ul></li><li>util : 一些常用的方法函数， treecache 用 zk 作为具体实现比较有意思。</li><li>web : 提供了 rest api 和 ui。<ul><li>alertmanager 和 pushgateway 都用了把静态资源打包的做法 (http.FS)，但 prometheus 却没有这么做，奇怪。 (更新，还是有的，只是和之前的代码写法有些不一样，用的是 go 的 //go:embed 注释)</li><li>对互联网后端开发而言，很多时候把写 api 作为工作的主体了，但实际上，web 的可能是最简单的部分……</li></ul></li></ul><blockquote><p>最重要的部分放在最后~~</p></blockquote><ul><li>promql : parse 和 query ，具体没怎么看细节。</li><li>storage : tsdb 的接口层，可以对接 remote ，也可以直接使用本地 tsdb。</li><li>tsdb<ul><li>db.go : 启动 tsdb 的入口</li><li>head.go : 插入数据的入口，series 的内存结构等。 是理解数据写入过程的最重要的文件。实际上，head 数据可以看做是 block 在内存中的展开状态，head 中的 chunk 写到一定阶段后就会由 compact 变成 block 存到磁盘中。</li><li>wal.go : 任何的数据操作，都会先写到 log 中，用于保证数据的安全，调用方为 head.Commit。使用 wal 和 checkpoint 是内存数据库非常通用的方法。 checkpoint 的逻辑 和 日志监听的逻辑 在 wlog 中。</li><li>record : 写入 wal 的具体事件的定义。</li><li>compact.go : 处理把数据写入 文件系统 成为一个 block 的过程，包括两类: 把内存中的 head 写入 block；把多个 block 合并，实际调用 index.Writer 和 chunks.Writer 等做实际写入操作。</li><li>block.go : 数据块的定义和操作，管理 读取、写入 block。一个数据块就是 一段时间内的所有数据的集合，包括 采集的指标值 和 指标本身的信息。 是数据最终的存在形态，数据通路是 db =&gt; head =&gt; chunk =&gt; block 。</li><li>chunks 和 chunkenc : chunk 的定义和操作。 chunkenc 中包含了几种 chunk 的序列化方法。</li><li>fileutil : 一些 file 的操作封装<ul><li>mmap : 文件内存映射。是读取 chunk 的方式，保证了低内存占用。</li></ul></li><li>index<ul><li>是理解 <code>持久化</code> 和 <code>查询</code> 最好的方式，分为 符号表 (用于压缩空间)、序列表(用于关联 chunks)、label表和posting表 (用于查询及关联 label 和 name) 以及 TOC (用于定位上述几张表)</li></ul></li><li>有几个重点：<ul><li>理解 series 的概念: 特定的 label 集合。 (series =&gt; labels.Labels)</li><li>理解 series 在内存中的状态 (stripeSeries =&gt; memSeries =&gt; headChunk =&gt; mmapchunk)</li><li>理解 block 的生成流程: series.headchunk =&gt; mmapchunk =&gt; compact/index/meta =&gt; block</li><li>理解一个数据写入的流程: labels+val =&gt; series + val =&gt; chunk</li></ul></li></ul></li></ul><p>设计上的想法:</p><ul><li>对于稍微复杂点的项目，一定会走上分层的道路，分层之后有逐渐会形成以 接口 为传递方式的调用 (而不是实例，否则要写 n 多类似的方法来兼容不同的type)。 接口化之后的好处是 单层内代码更简洁了；坏处是 想要跨层走一次流程会很懵，因为不知道具体的实现方是谁 (一般分层后每层都可能实现相同的方法)。</li></ul><h2 id="一些非常好的参考资料"><a href="#一些非常好的参考资料" class="headerlink" title="一些非常好的参考资料"></a>一些非常好的参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/tree/main/tsdb/docs/format">官方文档 tsdb 的序列化结构</a></li><li><a target="_blank" rel="noopener" href="https://ganeshvernekar.com/blog/prometheus-tsdb-the-head-block">prometheus TSDB</a></li><li><a target="_blank" rel="noopener" href="https://web.archive.org/web/20210622211933/https://fabxc.org/tsdb/">prometheus 发起人的博客</a></li></ul><h2 id="一些思考"><a href="#一些思考" class="headerlink" title="一些思考"></a>一些思考</h2><h3 id="你想要什么？"><a href="#你想要什么？" class="headerlink" title="你想要什么？"></a>你想要什么？</h3><ul><li>数据库具体究竟是怎么工作的？<ul><li>wal 的具体实现</li><li>block 的具体实现</li></ul></li><li>为什么我们现在脱离了数据库就没法写代码了一样？</li><li>一个这种级别的项目会花多少精力？<ul><li>prometheus 的发起人开始也是自己就发布了版本，而且还做了好多其他项目，这些牛逼的人为什么牛逼？</li></ul></li><li>项目成功的要素有哪些？<ul><li>能力、生态</li></ul></li><li>如何让读源码的收益最大化？<ul><li>通过: 阅读代码<ul><li>知道各自的职能是什么</li><li>知道各自是怎么实现的</li><li>知道相互是怎么连接的</li></ul></li><li>得到: 数据结构 + 过程演变</li><li>最好能: 临摹代码</li><li>如何把这件事做好?<ul><li>先可以大量实践一下，找到一些好的形态</li></ul></li><li>如何像一台机器一样阅读源码？<ul><li>主线流程跑一次</li><li>用 debug</li></ul></li></ul></li><li>LSM tree 和 其他数据库存储模型</li></ul><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul><li>找一个 LSM tree 的数据库实现看一下 <a href="/longblog/posts/23_02_11_18_15_code_reading_of_go_leveldb_and_others.html" name="golevelDB源码走读">golevelDB源码走读</a></li><li>找一个 B+ tree 的数据库实现看一下 <a href="/longblog/posts/23_02_11_18_15_code_reading_of_go_leveldb_and_others.html" name="golevelDB源码走读">golevelDB源码走读</a></li><li>对 k8s 的部分代码走读一下 <a href="/notpublish/index.html" name="k8s部分源码走读">k8s部分源码走读</a></li></ul><hr><blockquote><p>We may encounter many defeats, but we must not be defeated.<br>— <cite>Maya Angelou</cite></p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/longblog/tags/code-reading/">code reading</a> <a class="hover-with-bg" href="/longblog/tags/monitor/">monitor</a> <a class="hover-with-bg" href="/longblog/tags/prometheus/">prometheus</a> <a class="hover-with-bg" href="/longblog/tags/pushgateway/">pushgateway</a> <a class="hover-with-bg" href="/longblog/tags/%E4%BB%A3%E7%A0%81%E8%B5%B0%E8%AF%BB/">代码走读</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/longblog/posts/2302161036.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">一个golang三方库的常规内容</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/longblog/posts/22_11_23_23_02_disk_performance_and_network.html"><span class="hidden-mobile">关于磁盘和网络的性能的问题</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">备案: 粤ICP备2020131301号</a></span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script><script src="/longblog/js/events.js"></script><script src="/longblog/js/plugins.js"></script><script src="/longblog/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js"></script><script src="/longblog/js/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/longblog/static/js/showiframe.js"></script><script src="/longblog/js/boot.js"></script></body></html>