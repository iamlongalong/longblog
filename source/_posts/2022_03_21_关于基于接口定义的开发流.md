---
title: 关于基于接口定义的开发流
abbrlink: 22_03_21_关于基于接口定义的开发流
date: 2022-03-21 21:36:42
tags:
---

## 背景
之前做前端开发，需要依赖后端同学的接口文档，涉及到一些老接口的时候，经常出现接口信息疏于维护的情况，然后找这个找那个的，依然很难做到让接口信息完整，当时就在想，为什么不再要修改一个接口的时候，把接口文档顺便维护了呢？心中甚是鄙夷。

后来做后端开发，经常出现一些要求快速完成进行联调的情况，更甚至有临时改变一些功能的情况，自己可能顺手就加上了，然后上到测试环境让前端同学调一下，然后……就没有然后了，因为运行起来没什么问题，也没有谁让把接口文档补全，就这样搁置了。

再后来后端开发也要兼顾接口测试，接口测试 的用例梳理，是基于接口定义，一方面找到接口的参数边界，另一方面测试完整的场景，这时候才发现，之前的接口文档写得是多么简陋。
于是，就开始探索更好的后端接口开发工作流。

## 灵感来源及畅想

### 灵感1

接口文档的维护大体上分为两派，① 接口文档应当跟随代码，例如 swagger  ② 接口文档管理在专门的接口平台，例如 yapi。 这两派都有其拥护者。目前看到的，市场上很多企业还是走的第 ② 条路，主要原因，可能还是对后端人员来说上手简单，有好用的 UI，写接口就点点点几下；再加上给前端同学交付比较方便(仍一个链接过去)，带有 mock 功能，可能还有一些简单的 接口测试 功能，用起来很流畅。 用这种方式的一个弊端，可能就是 `容易疏于维护`。

基于代码的方案基本就是 swagger 的方式，在定义接口时，用 `注释` 或者 `装饰器` 等方式，将接口的元信息嵌入到代码中，这样就可以做到修改代码的时候，就可以顺便修改接口信息。 但这样的弊端就是： ① 部署不方便，yapi 可以独立部署，很稳定，基于代码的则可能随意改变，对使用方而言不够稳定。 ② mock 、test 等功能较弱，有些时候需要提供 这些功能时比较容易被要求更换。

### 灵感2

之前系统还不是很复杂时，主要对外提供 http 接口，后来，服务越来越多，服务间的通信则主要使用 rpc 方式，我们选择的 grpc 框架，该框架在创建接口时的方式，是基于 proto3 定义的接口，使用 protoc 直接生成对应的代码，将接口定义变成真正的 `接口`，然后由开发者自行实现该接口，达到提供真正的接口功能的目的。

我在想，http 和 rpc，都是远程通信的方式，从目的上看，本就没什么区别。看起来，只是 rpc 是基于自定义的 `数据格式` 及 `序列化方式`，而 http 整体看是个`通用的文本协议`。那么，是不是可以把 grpc 中的一些优点，应用到 http 的请求中来，甚至应用到 ws 等长链接协议中？

后来，看到 go-zero 这个项目中，脚手架工具的 go-ctl 就已经包含了这项功能，基于一个自定义的接口定义文档，生成一定模板下的基本代码。后来，看到 goframe 这个框架，在 2.x 的版本出来后，也瞄中了这项功能，提供了接口定义的方式。

### 更多的畅想

基于接口定义，我们可以做很多事情，例如： ① 基本代码自动生成 ② 接口文档自动生成 ③ 基本接口测试代码自动生成 。有了这些自动化手段，做开发时就可以很纯粹地关心业务逻辑即可。

## 如何行动起来

一切想法，要想产生真实的价值，就必须得要落地，而落地的方法，可以以实践为目标进行梳理，当有一定思路时，就赶紧行动起来。

目前，我可以先： ① 阅读 protobuff 的代码生产方式  ② 阅读 go-ctl 的代码生成方式  ③ 阅读 goframe 的代码生成方式 
然后： ④ 分析不同类型接口的差异 ⑤ 梳理 ws 的生成方式是什么样的  ⑥ 以 ws 为例，开发一版基本代码
