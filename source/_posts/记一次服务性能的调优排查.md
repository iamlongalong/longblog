---
title: è®°ä¸€æ¬¡æœåŠ¡æ€§èƒ½çš„è°ƒä¼˜æŽ’æŸ¥
abbrlink: 22_07_16_a_record_of_service_performance_improve
date: 2022-07-16 10:21
date updated: 2022-07-16 10:21
index_img: https://static.longalong.cn/img/photo-1529688124-e6c364d3285c
---

### äº‹æƒ…èµ·å› ï¼š

1.  æŸä¸€å¤©ï¼Œå¬åˆ°æµ©å…„è¯´æˆ‘ä»¬æœ‰ä¸ªå‘Šè­¦ï¼Œæ˜¯å› ä¸º event-tracking çš„ cpu ä½¿ç”¨è¶…æ ‡
![](https://static.longalong.cn/img/warning.png)

2.  æˆ‘æ„Ÿè§‰æ¯”è¾ƒå¥‡æ€ªï¼Œé¡ºå£é—®äº†ä¸‹æƒ…å†µï¼ŒåŽæ¥åˆå’Œ æµ©å…„ã€çª¦å…„ ä¸€èµ·çœ‹äº†ä¸‹å„ç§ç›‘æŽ§

### æŸ¥çœ‹ cpuã€å†…å­˜ã€ç½‘ç»œ æƒ…å†µ

![](https://static.longalong.cn/img/asynccode-12.png)

![](https://static.longalong.cn/img/asynccode-11.png)

å‘çŽ°å¾ˆå¥‡æ€ªï¼Œå†…å­˜å’Œ cpu æ˜¯çŒ›å¢žä¸ŠåŽ»çš„ï¼Œä½†ç½‘ç»œæµé‡å´éžå¸¸å°ã€‚

åˆå¬åˆ° æµ©å…„ è¯´å½“æ—¶æœºå™¨çš„ socket è¿žæŽ¥æ•°è¢«æ‰“æ»¡äº†ï¼ŒäºŽæ˜¯æ€€ç–‘æ˜¯ goroutine çš„é—®é¢˜ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹ goroutine ç›‘æŽ§
  

### æŸ¥çœ‹ goroutine ç›‘æŽ§

![](https://static.longalong.cn/img/asynccode-8.png)


å‘çŽ°ç¡®å®ž goroutine é£™å¾—éžå¸¸é«˜ã€‚ ä¹Ÿæ²¡å¤šæƒ³ï¼Œæ€€ç–‘æ˜¯ä¸æ˜¯æœ‰ for å¾ªçŽ¯é‡Œé¢èµ·äº† åç¨‹ï¼Œå¯¼è‡´ goroutine æ²¡æŽ§åˆ¶ä½ï¼Ÿ

äºŽæ˜¯å’Œ çª¦å…„ ä¸€å—å„¿ï¼Œä¸€é€šä»£ç æŸ¥çœ‹ï¼Œâ€¦â€¦é¢â€¦â€¦ï¼Œæ²¡å‘çŽ°å•¥é—®é¢˜ã€‚

æ­¤äº‹ä¸€ç›´è€¿è€¿äºŽæ€€ï¼Œå¬ç›¸å…³è´Ÿè´£äººè¯´ï¼Œåœ¨è®¡åˆ’é‡æž„ event-tracking ï¼Œæœ‰ç‚¹å®³æ€•ï¼Œæ¯•ç«Ÿç§æœ‰éƒ¨ç½²çš„é¡¹ç›®ä¸­ï¼Œæˆ‘è¿˜æœ‰äº›ä¾èµ– event-tracking çš„ sdk [ðŸ˜±]â€¦â€¦


ä½†ç”±äºŽ â‘  æ²¡æœ‰çŽ°åœºï¼Œæ²¡æ³•æŠ“å„ç§ profile â‘¡ æ²¡æœ‰ tracingï¼Œä¸çŸ¥é“ç©¶ç«Ÿå¡åœ¨å“ªé‡Œäº†

æ¯•ç«Ÿï¼Œæ—¥å¿—ã€ç›‘æŽ§ã€tracingã€pprof ç›¸å½“äºŽæˆ‘ä»¬çš„çœ¼ç›ï¼Œæ²¡æœ‰è¿™äº›ï¼ŒçŽ°åœ¨åšä¸€åˆ‡éƒ½ç›¸å½“äºŽç›²çŒœâ€¦â€¦

ä¸ºäº†å‡è½»ç§æœ‰åŒ–é€‚é…çš„å·¥ä½œï¼Œåœ¨æµ©å…„çš„æ€‚æ¿ä¸‹ï¼Œå¼€å§‹äº†ä¸€ç•ªè‡ªæ•‘æ“ä½œâ€¦â€¦

### è¿›ä¸€æ­¥æŽ’æŸ¥çš„å‡†å¤‡å·¥ä½œ

1.  ç”±äºŽä¸çŸ¥é“å„æŽ¥å£çš„å“åº”æƒ…å†µï¼ŒäºŽæ˜¯åˆæ­¥å»ºäº†ä¸ª metrics çš„æ¿å­ï¼Œç®€å•çœ‹äº†ä¸‹ï¼Œè§‰å¾—æŒ–ä¸åŒæŽ¥å£çš„å“åº”æ—¶é•¿å¯èƒ½æ²¡å•¥æ„ä¹‰ï¼Œè¿™åº”è¯¥æ˜¯ä¸ªç³»ç»Ÿæ€§é—®é¢˜ï¼ŒäºŽæ˜¯æ”¾å¼ƒç»§ç»­åšæ¿å­ï¼Œè½¬å‘å…¶ä»–æ–¹å‘ã€‚

2.  ç”±äºŽå·²ç»åœ¨æ¡†æž¶ä¸­é›†æˆäº† tracing çš„ä¸œè¥¿ï¼ŒäºŽæ˜¯èŠ±äº†åŠä¸ªå°æ—¶æŠŠ event-tracking çš„ æ‰€æœ‰ tracing æŽ¥ä¸Šã€‚(åŒ…æ‹¬ redisã€dbã€kafkaã€http request)

3.  ä¸ºäº†èƒ½å¤çŽ°é«˜åŽ‹åŠ›ä¸‹çš„åœºæ™¯ï¼Œåœ¨åŽ‹æµ‹æœºä¸Šè£…äº† ab 

### è¯•ä¸‹æœªåšè°ƒæ•´æ—¶çš„åŽ‹æµ‹æƒ…å†µ

#### åŽ‹æµ‹ç»“æžœ

å¹¶å‘ 200ï¼Œ qps 54

![](https://static.longalong.cn/img/asynccode-2.png)


![](https://static.longalong.cn/img/asynccode-10.png)

tracing 

![](https://static.longalong.cn/img/20220716105356.png)


æœ‰å››ä¸ªè¡¨çŽ°å¥‡æ€ªçš„åœ°æ–¹ï¼š

1.  è´Ÿè½½éžå¸¸ä¸å‡è¡¡ï¼Œå¿…å®šæœ‰é¬¼

2.  nginx åˆ° pod çš„æ—¶é—´å±…ç„¶è¾¾åˆ°æ•°ç§’

3.  Pod å†… produce kafka çš„æ—¶é—´ å±…ç„¶å’Œ æ•´ä¸ªè¯·æ±‚çš„æ—¶é•¿ä¸€æ ·

4.  åœ¨ kafka é˜Ÿåˆ—ä¸­ï¼Œå±…ç„¶å¡äº†è¿™ä¹ˆé•¿æ—¶é—´


#### å…ˆæ€€ç–‘ä¸‹ kafka å®žä¾‹çš„é—®é¢˜

kafka ç›‘æŽ§ 

![](https://static.longalong.cn/img/asynccode-6.png)

å°±è¿™ç‚¹é‡ï¼Œè¿œè¿œè¾¾ä¸åˆ° kafka çš„ç“¶é¢ˆï¼Œè·³è¿‡ã€‚

#### æ€€ç–‘ä¸‹ æ˜¯ä¸æ˜¯ä»£ç ä¸­ç”¨äº† åŒæ­¥å‘é€

![](https://static.longalong.cn/img/asynccode.png)

çœ‹æ¥å¹¶ä¸æ˜¯ï¼ŒæŽ’é™¤ã€‚

#### æ€€ç–‘ä¸€ä¸‹ ikafka åŒ…çš„é—®é¢˜

æ­¤æ—¶å‘çŽ° ikafka æ²¡æœ‰æŽ¥ metrics ï¼ŒäºŽæ˜¯çœ‹äº†ä¸‹ä¹‹å‰å†™çš„æ–‡æ¡£ï¼Œæƒ³æŠŠ ikafka çš„ metrics æŽ¥ä¸Šã€‚

ç„¶åŽå‘çŽ° æˆ‘æƒ³æŽ¥çš„æ˜¯ sarama ï¼Œä½† ikafka æ²¡æœ‰æš´éœ² metrics å‡ºæ¥ï¼Œä¹Ÿæ²¡æœ‰æŠŠ sarama çš„ metrics æŽ¥å£æš´éœ²å‡ºæ¥ï¼Œæ— æžœâ€¦â€¦

è¿™ä¸ªé—®é¢˜ç•™åˆ°ä¹‹åŽå†æ€€ç–‘å§

#### æ€€ç–‘ä¸€ä¸‹ kafka çš„é…ç½®é—®é¢˜

![](https://static.longalong.cn/img/asynccode-1.png)

æžœç„¶ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œconsumer çš„ é˜Ÿåˆ—æ•° å±…ç„¶ä»…è®¾ç½®äº† 1 ï¼Œè¿™å²‚ä¸æ˜¯æ„å‘³ç€ï¼Œæ¶ˆæ¯åªèƒ½ä¸€æ¡æ¡ä»Ž kafka å–å›žæ¥ï¼Ÿé‚£ä¸å¾—è€æ…¢äº†â€¦â€¦

å¦å¤–ï¼Œçœ‹åˆ°æ²¡æœ‰å¼€ autocommitï¼ŒäºŽæ˜¯ä¹Ÿé¡ºæ‰‹åŠ ä¸Šã€‚
![](https://static.longalong.cn/img/20220716105438.png)


okï¼Œè¿™ä¸‹é¡ºçœ¼å¤šäº†ã€‚å…¶ä»–ä¹Ÿä¸çŸ¥é“å’‹æ ·ï¼Œå…ˆåŽ‹ä¸€æ³¢è¯•ä¸‹å§ã€‚

### è°ƒæ•´ channel size åŽçš„åŽ‹æµ‹

åˆšå‡†å¤‡åŽ‹çš„ï¼Œçœ‹äº†ä¸€çœ¼ grafana ï¼Œæ‡µäº†â€¦â€¦ 

![](https://static.longalong.cn/img/asynccode-4.png)

  

å•¥æƒ…å†µï¼Ÿï¼Ÿï¼Ÿ Cpu ç›´æŽ¥è¢«æ‹‰æ»¡äº†ï¼Ÿï¼Ÿï¼Ÿ

å“å¾—æˆ‘åæ‰‹å°±æŠ“äº†ä¸€æ³¢ pprofile

![](https://static.longalong.cn/img/asynccode-9.png)


å‘çŽ°å±…ç„¶æœ‰å¤§é‡çš„ park æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™æ˜¾ç„¶å°±æ˜¯ goroutine ç–¯ç‹‚åˆ‡æ¢å¯¼è‡´çš„é—®é¢˜å•Šã€‚

æŒ‰ä»¥å¾€çš„ç»éªŒï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ for å¾ªçŽ¯ä¸­çš„ select ä¸æ˜¯å…¨é˜»å¡žçš„ã€‚æ­¤æ—¶è·‘åŽ»æœäº†ä¸€åœˆ `for` çš„ä»£ç ã€‚æ²¡å‘çŽ°é—®é¢˜ï¼Œæ¯ä¸ª for å¾ªçŽ¯éƒ½è¿˜æ¯”è¾ƒè§„èŒƒâ€¦â€¦

äºŽæ˜¯å›žæ¥æŽ¥ç€çœ‹ pprofileï¼Œæ³¨æ„åˆ° å·¦è¾¹ kafka çš„è°ƒç”¨ï¼ŒæŒ‰ç†ï¼Œè¿™æ˜¯å±žäºŽåº•å±‚åŒ…çš„è°ƒç”¨å•Šï¼Œåº”è¯¥ä¸ä¼šæœ‰å•¥é—®é¢˜å•Šã€‚

è·Ÿäº†ä¸€åœˆä»£ç ï¼Œç”±äºŽæ˜¯ç›´æŽ¥çš„ cgo è°ƒç”¨ï¼Œä¹Ÿå¾ˆéš¾ç»§ç»­è¿½ä¸‹åŽ»äº†ã€‚

![](https://static.longalong.cn/img/origin_img_v2_e59df2f5-be93-4e16-8749-3f500e19ab9g.jpg)
  

æƒ³åˆ°ä¹‹å‰ confluent ç»™æˆ‘ç•™ä¸‹çš„å¥‡å¥‡æ€ªæ€ªçš„å°è±¡ (ä¸»è¦æ˜¯å› ä¸ºé»‘ç›’é—®é¢˜)ï¼Œå†åŠ ä¸Šå¯¹ sarama åšè¿‡æ¯”è¾ƒä»”ç»†çš„æºç é˜…è¯»ï¼Œæƒ³ç€æ—¢ç„¶ confluent ä¸å¥½è°ƒè¯•ï¼Œæ¢æˆ sarama å…ˆè¯•è¯•å§â€¦â€¦


### åˆ‡æ¢ sarama åŽçš„åŽ‹æµ‹

å¹¶å‘ 200ï¼Œ qps 940

![](https://static.longalong.cn/img/asynccode-3.png)

  

grafana ç›‘æŽ§

![](https://static.longalong.cn/img/asynccode-7.png)

  

æ—¶é—´åˆ†å¸ƒåˆç†

![](https://static.longalong.cn/img/asynccode-5.png)

  
æ‰“å®Œ   æ”¶å·¥ ï¼

### ç»“å±€ï¼š

1.  Event-tracking çš„æ€§èƒ½é—®é¢˜è‡³å°‘ç®—æ˜¯è§£äº†

2.  å¦‚æžœéœ€è¦çš„è¯ï¼Œå¯ä»¥å†åŽ»æ•´ç†ä¸‹ confluent çš„æ­£ç¡®æ‰“å¼€æ–¹å¼ ( è¿˜æ˜¯ç®—äº†â€¦â€¦ ï¼Œç›´æŽ¥ç”¨ sarama æˆ–è€… kafka-go ä¸é¦™å— )

3.  å…¬å…±åŒ…æœ€å¥½è¿˜æ˜¯æä¾›ä¸€äº›ç»Ÿä¸€çš„ metrics æŽ¥å£ã€æä¾›ç»Ÿä¸€çš„ tracing è®¾ç½®

4.  å¯¹äºŽæˆ‘ä»¬çŽ°åœ¨å¤§å¤šæ•°çš„ä¸šåŠ¡åœºæ™¯ï¼Œ1c çš„ cpu æ”¯æ’‘ä¸ª 1000qps é—®é¢˜æ˜¯ä¸å¤§çš„ï¼Œå¤§å®¶å¯èƒ½éœ€è¦æ›´æ–°ä¸‹å¯¹æ€§èƒ½çš„æ„Ÿæ€§è®¤è¯†


---
> There are two kinds of failures: those who thought and never did, and those who did and never thought.
> â€” <cite>Laurence J. Peter</cite>